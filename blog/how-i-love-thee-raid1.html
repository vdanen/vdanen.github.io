<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" type="text/css" href="https://vdanen.github.io/theme/css/elegant.prod.9e9d5ce754.css" media="screen">
        <link rel="stylesheet" type="text/css" href="https://vdanen.github.io/theme/css/custom.css" media="screen">

        <link rel="dns-prefetch" href="//fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin>

        <meta name="author" content="Vincent Danen" />

        <meta property="og:type" content="article" />
        <meta name="twitter:card" content="summary">

<meta name="keywords" content=", Linux, " />

<meta property="og:title" content="How I love thee RAID1 "/>
<meta property="og:url" content="https://vdanen.github.io/blog/how-i-love-thee-raid1.html" />
<meta property="og:description" content="Well, having a RAID1 setup on this server has saved my a$$ in a huge way. Yesterday I started getting notifications of a smart failure on one of the drives (I have two configured as a RAID1 across a few partitions). So I went down to the colo to swap …" />
<meta property="og:site_name" content="Annvix" />
<meta property="og:article:author" content="Vincent Danen" />
<meta property="og:article:published_time" content="2006-02-15T23:11:00-07:00" />
<meta name="twitter:title" content="How I love thee RAID1 ">
<meta name="twitter:description" content="Well, having a RAID1 setup on this server has saved my a$$ in a huge way. Yesterday I started getting notifications of a smart failure on one of the drives (I have two configured as a RAID1 across a few partitions). So I went down to the colo to swap …">

        <title>How I love thee RAID1  · Annvix
</title>
        <link href="https://vdanen.github.io/recent.atom" type="application/atom+xml" rel="alternate" title="Annvix - Full Atom Feed" />



    </head>
    <body>
        <div id="content">
            <div class="navbar navbar-static-top">
                <div class="navbar-inner">
                    <div class="container-fluid">
                        <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </a>
                        <a class="brand" href="https://vdanen.github.io/"><span class=site-name>Annvix</span></a>
                        <div class="nav-collapse collapse">
                            <ul class="nav pull-right top-menu">
                                <li >
                                    <a href=
                                       https://vdanen.github.io
                                    >Home</a>
                                </li>
                                <li ><a href="https://vdanen.github.io/about.html">About</a></li>
                                <li ><a href="https://vdanen.github.io/documentation.html">Documentation</a></li>
                                <li ><a href="https://vdanen.github.io/categories.html">Categories</a></li>
                                <li ><a href="https://vdanen.github.io/tags.html">Tags</a></li>
                                <li ><a href="https://vdanen.github.io/archives.html">Archives</a></li>
                                <li><form class="navbar-search" action="https://vdanen.github.io/search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="container-fluid">
                <div class="row-fluid">
                    <div class="span1"></div>
                    <div class="span10">
<article itemscope>
<div class="row-fluid">
    <header class="page-header span10 offset2">
        <h1>
            <a href="https://vdanen.github.io/blog/how-i-love-thee-raid1.html">
                How I love thee RAID1
            </a>
        </h1>
    </header>
</div>

<div class="row-fluid">
        <div class="span8 offset2 article-content">
            
            <p>Well, having a RAID1 setup on this server has saved my a$$ in a huge way.  Yesterday I started getting notifications of a smart failure on one of the drives (I have two configured as a RAID1 across a few partitions).  So I went down to the colo to swap the drive (after finding a spare here and testing the heck out of it first).</p>
<p>Well, wouldn't you know but the drive I pulled, while having some issues (they weren't overly severe, just being unable to read some blocks), wasn't the one with the real problems.  After replacing the drive and getting the first three partitions sync'd up (the smallest) I came back home expecting to login, check the status of the final sync, and carry on with my night.  Well, get home and I can ping the machine but it's not serving any data.  Drive back to the colo.</p>
<p>Turns out, the other drive is <em>really</em> dying.  Good thing I brought everything from the first trip back (my tools, etc.) so I could put the drive I had just pulled out back in and take the other one out.  Fortunately, the data problems weren't across the first threee (system) partitions (/boot, /, and /usr/local), but the partition containing all my web/mail files didn't finish syncing due to all the problems.  So after booting up with the original drive (and my new drive), I didn't have a /dev/md3 because it failed utterly the last few times.  Had to re-assemble that array from the original drive, then hot-add the new drive to it, to get the data back.</p>
<p>So my 20 minute job ended up taking about 5 hours to figure out.  <sigh>  But wouldn't you know it, when I got back home just now, I did an rsync across from my other server (which does a daily rsync) and the changed files were what I expected.  I didn't lose a single file.  I'm amazed; I thought for sure I would have lost nearly a day's worth of mail archives and stuff (everything else is fairly static with the exception of the SQL database which lives on the / partition which synced up ok).Moral of the story: RAID1 redudancy <em>works</em>.  I love it.</p>
<p>Now the TODO is to have rsync run every four hours, rather than once a day so at the absolute most, all I can lose is 4hrs worth of stuff (this goes for the dumped and sync'd SQL databases as well).</p>
<p>The other TODO (already scheduled for this summer) is to replace the machines I have at the colo with two <a href="http://ca.sun.com/en/catalog/?n-state=http://catalog.sun.com/productinfo.xml?site%3dCANENCA%26catalogue%3dFC%26segment%3dFC_R%26item%3dFC_SC_CAT%26group%3d2010%26fid%3d5118%26id%3d13158%26partnerid%3dcacanen~~~G!01AC4B5F334B!WBPkexcnEpBE33lF~standard~ws-nocache">Sun x2100 servers</a>... these little 1U baddies are <em>awesome</em> (and, BTW, Annvix runs peachy on them).  Opteron CPUs, dual gigabit nics (both fully supported), SATA support for two drives (with front-accessible trays no less!)...  I am so getting two of these.  Not only will they nicely replace 6U of servers with just 2U but <b>front-loading trays!</b>  I won't have to take the machines out of the rack for anything less serious than a motherboard failure.  Sweet machines and reasonably priced too.</p>
<p>Too bad they don't have space for a third drive tho... it would be nice to set one drive aside as a spare.</p>
<p>Some quick notes for those interested in the implementation (and how easy it was to do this, aside from the really dying drive not reporting SMART information to smartd (bad drive!)):</p>
<p>Login and set the partitions of the dying drive to faulty:</p>
<pre>
# mdadm --manage --set-faulty /dev/md0 /dev/hda1
</pre>

<p>(and repeat for all partitions on /dev/hda with all your /dev/mdX devices; in my case I had four: /dev/md[0123])</p>
<p>Next, hot-remove the faulty devices from the RAID arrays (need to be marked as faulty first):</p>
<pre>
# mdadm /dev/md0 -r /dev/hda1
</pre>

<p>and repeat for all partitions.  Next, bring the machine down (after doing a "cat /proc/mdstat" to make sure they're really down; the arrays will be marked as running in degraded mode with a status of [U_]).  Swap out the drive.  Boot the machine again.  It's really a good idea here to make sure you can boot off of <em>either</em> drive (I do this with GRUB and set it up on both drives because here /dev/md0 is /boot, so it's accessible on both machines (as, ie. /dev/hda1 and /dev/hdc1) and then GRUB can boot from either.  This is one reason I much prefer GRUB to lilo as with GRUB I can do this, with LILO I couldn't (maybe you can now, I don't know... I haven't touched LILO in about 2 years).</p>
<p>Anyways, once you're back up and running, re-partition the new drive to match the old drive (making sure the partition types are set to fd for the RAIDed partitions).  Then hot-add them back to the array:</p>
<pre>
# mdadm /dev/md0 -a /dev/hda1
</pre>

<p>What /proc/mdstat or you can use "mdadm --detail /dev/md0" to view progress and other neat info.  The arrays will reconstruct themselves and, unless you have an issue like me, you're good to go.  So, realistically, you're running three mdadm commands with a little hardware swapping in between.  I don't think a 20 minute estimate for downtime was too unrealistic.</p>
<p>Anyways, everything is back up without a problem (knock on wood) so that's nice.  I tell ya tho... front-loading drive trays would have been fantastic.  Serial ATA would have been fantastic too.  Luckily, those servers will only be there for a few more months than they can retire back here and replace an aging LAN server (with some new drives, of course) and maintaining these remote servers should be much simpler.</p>


             
 
            
            
            







            <hr/>
        </div>
        <section id="article-sidebar" class="span2">
            <h4>Published</h4>
            <time itemprop="dateCreated" datetime="2006-02-15T23:11:00-07:00">Wed 15 February 2006</time>
            <h4>Category</h4>
            <a class="category-link" href="https://vdanen.github.io/categories.html#linux-ref">Linux</a>
<h4>Contact</h4>
<div id="sidebar-social-link">
    <a href="https://twitter.com/vdanen" title="" target="_blank" rel="nofollow noopener noreferrer">
        <svg xmlns="http://www.w3.org/2000/svg" aria-label="Twitter" role="img" viewBox="0 0 512 512"><rect width="512" height="512" rx="15%" fill="#1da1f3"/><path fill="#fff" d="M437 152a72 72 0 0 1-40 12 72 72 0 0 0 32-40 72 72 0 0 1-45 17 72 72 0 0 0-122 65 200 200 0 0 1-145-74 72 72 0 0 0 22 94 72 72 0 0 1-32-7 72 72 0 0 0 56 69 72 72 0 0 1-32 1 72 72 0 0 0 67 50 200 200 0 0 1-105 29 200 200 0 0 0 309-179 200 200 0 0 0 35-37"/></svg>
    </a>
    <a href="https://github.com/vdanen" title="" target="_blank" rel="nofollow noopener noreferrer">
        <svg xmlns="http://www.w3.org/2000/svg" aria-label="GitHub" role="img" viewBox="0 0 512 512"><rect width="512" height="512" rx="15%" fill="#1B1817"/><path fill="#fff" d="M335 499c14 0 12 17 12 17H165s-2-17 12-17c13 0 16-6 16-12l-1-50c-71 16-86-28-86-28-12-30-28-37-28-37-24-16 1-16 1-16 26 2 40 26 40 26 22 39 59 28 74 22 2-17 9-28 16-35-57-6-116-28-116-126 0-28 10-51 26-69-3-6-11-32 3-67 0 0 21-7 70 26 42-12 86-12 128 0 49-33 70-26 70-26 14 35 6 61 3 67 16 18 26 41 26 69 0 98-60 120-117 126 10 8 18 24 18 48l-1 70c0 6 3 12 16 12z"/></svg>
    </a>
    <a href="https://www.linkedin.com/in/vdanen/" title="" target="_blank" rel="nofollow noopener noreferrer">
        <svg xmlns="http://www.w3.org/2000/svg" aria-label="LinkedIn" role="img" viewBox="0 0 512 512" fill="#fff"><rect width="512" height="512" rx="15%" fill="#0077b5"/><circle cx="142" cy="138" r="37"/><path stroke="#fff" stroke-width="66" d="M244 194v198M142 194v198"/><path d="M276 282c0-20 13-40 36-40 24 0 33 18 33 45v105h66V279c0-61-32-89-76-89-34 0-51 19-59 32"/></svg>
    </a>
    <a href="https://infosec.exchange/@vdanen" title="" target="_blank" rel="nofollow noopener noreferrer">
        <svg xmlns="http://www.w3.org/2000/svg" aria-label="Mastodon" role="img" viewBox="0 0 512 512" fill="#fff"><rect width="512" height="512" rx="15%"/><path d="m409 290c-5 24-43 50-85 56-86 11-137-6-137-6 3 13-4 54 70 52 31 0 58-7 58-7l2 27c-51 24-107 15-140 6-67-17-79-90-81-162v-59c0-74 49-96 49-96 50-24 180-22 222 0 0 0 49 22 49 96 0 0 1 55-7 93" fill="#3088d4"/><path d="m358 202v91h-35v-88c0-18-8-27-23-27-18 0-27 11-27 33v47h-34v-47c0-22-9-33-27-33-15 0-23 9-23 27v88h-35v-91c0-18 5-60 52-60 39 0 50 37 50 37s10-37 50-37c45 0 52 42 52 60"/></svg>
    </a>
</div>
            





            





        </section>
</div>
</article>
<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe.
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides.
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo https://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>                    </div>
                    <div class="span1"></div>
                </div>
            </div>
        </div>
<footer>




    <div id="fpowered">
        Powered by: <a href="http://getpelican.com/" title="Pelican Home Page" target="_blank" rel="nofollow noopener noreferrer">Pelican</a>
        Theme: <a href="https://elegant.oncrashreboot.com/" title="Theme Elegant Home Page" target="_blank" rel="nofollow noopener noreferrer">Elegant</a>
    </div>
</footer>            <script src="//code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
        <script src="https://vdanen.github.io/theme/js/elegant.prod.9e9d5ce754.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

    <script>
    (function () {
        if (window.location.hash.match(/^#comment-\d+$/)) {
            $('#comment_thread').collapse('show');
        }
    })();
    window.onhashchange=function(){
        if (window.location.hash.match(/^#comment-\d+$/))
            window.location.reload(true);
    }
    $('#comment_thread').on('shown', function () {
        var link = document.getElementById('comment-accordion-toggle');
        var old_innerHTML = link.innerHTML;
        $(link).fadeOut(200, function() {
            $(this).text('Click here to hide comments').fadeIn(200);
        });
        $('#comment_thread').on('hidden', function () {
            $(link).fadeOut(200, function() {
                $(this).text(old_innerHTML).fadeIn(200);
            });
        })
    })
</script>

    </body>
    <!-- Theme: Elegant built for Pelican
        License : MIT -->
</html>