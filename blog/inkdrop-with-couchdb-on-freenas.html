<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" type="text/css" href="https://vdanen.github.io/theme/css/elegant.prod.9e9d5ce754.css" media="screen">
        <link rel="stylesheet" type="text/css" href="https://vdanen.github.io/theme/css/custom.css" media="screen">

        <link rel="dns-prefetch" href="//fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin>

        <meta name="author" content="Vincent Danen" />

        <meta property="og:type" content="article" />
        <meta name="twitter:card" content="summary">

<meta name="keywords" content="freenas, couchdb, inkdrop, Macos, " />

<meta property="og:title" content="Inkdrop with CouchDB on FreeNAS "/>
<meta property="og:url" content="https://vdanen.github.io/blog/inkdrop-with-couchdb-on-freenas.html" />
<meta property="og:description" content="I have a terrible memory, which means that I rely on a lot of tools and methodologies (like GTD, Getting Things Done) to help me track things. This also means that I have a lot of different tools ,and I regularly re-evaluate and change them if something new can meet …" />
<meta property="og:site_name" content="Annvix" />
<meta property="og:article:author" content="Vincent Danen" />
<meta property="og:article:published_time" content="2020-02-23T19:00:00-07:00" />
<meta name="twitter:title" content="Inkdrop with CouchDB on FreeNAS ">
<meta name="twitter:description" content="I have a terrible memory, which means that I rely on a lot of tools and methodologies (like GTD, Getting Things Done) to help me track things. This also means that I have a lot of different tools ,and I regularly re-evaluate and change them if something new can meet …">

        <title>Inkdrop with CouchDB on FreeNAS  · Annvix
</title>
        <link href="https://vdanen.github.io/recent.atom" type="application/atom+xml" rel="alternate" title="Annvix - Full Atom Feed" />



    </head>
    <body>
        <div id="content">
            <div class="navbar navbar-static-top">
                <div class="navbar-inner">
                    <div class="container-fluid">
                        <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </a>
                        <a class="brand" href="https://vdanen.github.io/"><span class=site-name>Annvix</span></a>
                        <div class="nav-collapse collapse">
                            <ul class="nav pull-right top-menu">
                                <li >
                                    <a href=
                                       https://vdanen.github.io
                                    >Home</a>
                                </li>
                                <li ><a href="https://vdanen.github.io/about.html">About</a></li>
                                <li ><a href="https://vdanen.github.io/documentation.html">Documentation</a></li>
                                <li ><a href="https://vdanen.github.io/categories.html">Categories</a></li>
                                <li ><a href="https://vdanen.github.io/tags.html">Tags</a></li>
                                <li ><a href="https://vdanen.github.io/archives.html">Archives</a></li>
                                <li><form class="navbar-search" action="https://vdanen.github.io/search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="container-fluid">
                <div class="row-fluid">
                    <div class="span1"></div>
                    <div class="span10">
<article itemscope>
<div class="row-fluid">
    <header class="page-header span10 offset2">
        <h1>
            <a href="https://vdanen.github.io/blog/inkdrop-with-couchdb-on-freenas.html">
                Inkdrop with CouchDB on FreeNAS
            </a>
        </h1>
    </header>
</div>

<div class="row-fluid">
        <div class="span8 offset2 article-content">
            
            <p><img alt="Image" src="https://vdanen.github.io/images/inkdrop.png"></p>
<p>I have a terrible memory, which means that I rely on a lot of tools and methodologies (like GTD, Getting Things Done) to help me track things.  This also means that I have a lot of different tools ,and I regularly re-evaluate and change them if something new can meet my ever-changing needs.</p>
<p>For the last two years I've been using <a href="https://happenapps.com/">Quiver</a> to categorize and keep notes.  These are notes for myself of people, projects, interesting things, escalations, etc.  These are also notes on nearly every meeting I attend.  For obvious reasons, these are sensitive and need to be kept under my own control.  Prior to Quiver, I was using <a href="https://c-command.com/eaglefiler/">EagleFiler</a> (incidentally, I still use EagleFiler, just not for note keeping -- it's a great way to organize and collect files).</p>
<p>While Quiver worked quite well, it has limitations.  As I try to do more work from my iPad rather than my laptop, the companion Quiver iOS app was showing it's limitations.  I could share the notes via my own internal WebDAV server, but it was read-only.  That is great if I only want a reference, but to fully move to my iPad for the "normal day to day" stuff I needed something where I could review and edit notes.</p>
<p>I recently came across <a href="https://inkdrop.app/">Inkdrop</a> which is a note-taking application similar to Quiver with a more robust set of features, including iOS applications that will edit, and a better way of synchronizing those notes.  While Inkdrop does provide a server to store the data (which is no good for me since I want to retain full control of my data), it does allow you to use a local CouchDB server.  It also has a subscription of $5/mo which, if it can do what I need it to do, is worth it to me (particularly with the travel I've been doing of late).</p>
<p>The big things for me were standing up a CouchDB server (never played with it before) and being able to convert my Quiver library into a format that Inkdrop can use.  Fortunately, both Quiver and Inkdrop use JSON files for the metadata so with a little bit of elbow grease I figured I could make it work.  This post covers a few things: standing up the CouchDB server, getting Inkdrop to sync to it, and finally converting the data I already had in Quiver (nearly 1800 notes).</p>
<h2>CouchDB in a FreeNAS jail</h2>
<p>The first step was to create the FreeNAS jail in which I was going to run CouchDB.  This needed to be running on my local network and not accessible to the internet.  It also needed to use HTTPS.  The first step was to create a new jail named <code>inkdrop</code> in FreeNAS (using the web UI).  Once that was done, I logged into the FreeNAS server, entered the jail, and installed the <code>pkg</code> tool to install what I needed for CouchDB:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>iocage<span class="w"> </span>console<span class="w"> </span>inkdrop
<span class="c1"># pkg</span>
<span class="c1"># pkg install couchdb2 curl</span>
<span class="c1"># cd /usr/local/etc/couchdb2</span>
<span class="c1"># vi local.ini</span>
</code></pre></div>

<p>At this point we need to assign the admin user a password and note it in the <em>local.ini</em> file.  There are other files to edit as well:</p>
<div class="highlight"><pre><span></span><code># vi vm.args
</code></pre></div>

<p>In <em>vm.args</em>, change the <code>setcookie</code> option from its default.</p>
<div class="highlight"><pre><span></span><code># vi /etc/rc.conf
</code></pre></div>

<p>In <em>rc.conf</em> set <code>coudchdb2_enable</code> to <strong>YES</strong>.  Now we can start the service and initialize our database.  The database will be named <code>inkdrop</code> and the admin user's password is <strong>passwd</strong> in the following examples.</p>
<div class="highlight"><pre><span></span><code><span class="cp"># service couchdb2 start</span>
<span class="cp"># curl -X PUT http:</span><span class="c1">//admin:passwd@127.0.0.1:5984/_users</span>
<span class="cp"># curl -X PUT http:</span><span class="c1">//admin:passwd@127.0.0.1:5984/_replicator</span>
<span class="cp"># curl -X PUT http:</span><span class="c1">//admin:passwd@127.0.0.1:5984/_global_changes</span>
<span class="cp"># curl -X PUT http:</span><span class="c1">//admin:passwd@127.0.0.1:5984/inkdrop</span>
</code></pre></div>

<h2>Install nginx as the CouchDB proxy</h2>
<p>The next step is to use nginx as the proxy for CouchDB so that we can have HTTPS requests rather than HTTP.</p>
<div class="highlight"><pre><span></span><code># pkg install nginx
# cd /usr/local/etc/nginx
# vi nginx.conf
</code></pre></div>

<p>At this point you want to follow the <a href="https://docs.inkdrop.app/manual/synchronizing-in-the-cloud/#how-to-set-up-your-own-sync-server">Inkdrop instructions for setting up your own sync server</a>.  That should get nginx nicely configured.  The next step is to use Let's Encrypt in the FreeNAS jail.  I've blogged about this in the past here, with <a href="https://annvix.com/blog/using-letsencrypt-on-freenas">Using LetsEncrypt on FreeNAS</a> and <a href="https://annvix.com/blog/using-letsencrypt-with-plex">Using LetsEncrypt with Plex</a> so I won't go into a lot of detail, but will simply note the commands used:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># pkg install git</span>
<span class="c1"># cd /root</span>
<span class="c1"># git clone https://github.com/Neilpang/acme.sh.git</span>
<span class="c1"># cd acme.sh</span>
<span class="c1"># ./acme.sh --install</span>
<span class="c1"># cd /root/.acme.sh</span>
<span class="c1"># export CF_Key=&quot;api_key&quot;</span>
<span class="c1"># export CF_Email=&quot;email_addr&quot;</span>
<span class="c1"># ./acme.sh --issue --dns dns_cf -d inkdrop.hostname --fullchain-file /usr/local/etc/nginx/fullchain.pem --key-file /usr/local/etc/nginx/privkey.pem</span>
<span class="c1"># crontab -l</span>
<span class="mi">12</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="s2">&quot;/root/.acme.sh&quot;</span><span class="o">/</span><span class="n">acme</span><span class="o">.</span><span class="n">sh</span><span class="w"> </span><span class="o">--</span><span class="n">cron</span><span class="w"> </span><span class="o">--</span><span class="n">home</span><span class="w"> </span><span class="s2">&quot;/root/.acme.sh&quot;</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="nb nb-Type">null</span>
</code></pre></div>

<p>With our SSL certificate setup and making sure the cronjob is set as well, we can now start nginx and test if we can connect to our CouchDB server over HTTPS:</p>
<div class="highlight"><pre><span></span><code><span class="cp"># vi /etc/rc.conf</span>
<span class="cp"># service nginx start</span>
<span class="cp"># curl -X GET https:</span><span class="c1">//127.0.0.1:6984/_all_dbs</span>
<span class="p">{</span><span class="s">&quot;error&quot;</span><span class="o">:</span><span class="s">&quot;unauthorized&quot;</span><span class="p">,</span><span class="s">&quot;reason&quot;</span><span class="o">:</span><span class="s">&quot;You are not a server admin.&quot;</span><span class="p">}</span>
<span class="cp"># curl -X GET https:</span><span class="c1">//admin:passwd@127.0.0.1:6984/_all_dbs</span>
<span class="p">[</span><span class="s">&quot;_global_changes&quot;</span><span class="p">,</span><span class="s">&quot;_replicator&quot;</span><span class="p">,</span><span class="s">&quot;_users&quot;</span><span class="p">,</span><span class="s">&quot;inkdrop&quot;</span><span class="p">]</span>
</code></pre></div>

<p>In <em>rc.conf</em> you want to set <code>nginx_enable</code> to <strong>YES</strong>.</p>
<p>If you intend to use Inkdrop on your mobile device, you now need to create the mobile design document as per <a href="https://docs.inkdrop.app/manual/synchronizing-in-the-cloud/#support-mobile-sync">Inkdrop's mobile sync documentation</a>, which is effectively running:</p>
<div class="highlight"><pre><span></span><code><span class="cp"># curl -X PUT https:</span><span class="c1">//admin:passwd@127.0.0.1:6984/inkdrop -d &#39;{ &quot;_id&quot;: &quot;_design/mobile&quot;, &quot;filters&quot;: { &quot;sync&quot;: &quot;function (doc) { return doc._id.indexOf(&#39;file:&#39;) === -1 }&quot; } }&#39;</span>
</code></pre></div>

<h2>Mobile Sync</h2>
<p>At this point you should have a fully functional CouchDB running behind nginx in a FreeNAS jail.  Now you can point Inkdrop to your server for syncing.  You can set this up to be accessible from anywhere, or you can leave it accessible only internally.  That's the way I chose to do it since you can edit documents while disconnected and it will sync back to the server when the client is able to connect.  This allows for complete privacy by not making it available outside of your own network, but makes it portable enough that you can take your notes with you so you can add and edit as you're out and about.</p>
<p>The only thing that would make this even better for me would be for Inkdrop to have PIN or TouchID/FaceID protection on the mobile device.</p>
<h2>Converting from Quiver to Inkdrop</h2>
<p>Now if you're like me and you've used Quiver in the past, there is good news!  You <em>can</em> convert from Quiver to Inkdrop.  I had to scratch my own itch here as there was no conversion tool available.  Thankfully, Quiver uses JSON files that can be parsed and, for Inkdrop, I can talk directly to the CouchDB server.  Because of this I could see the content/format of what I had in Quiver, and what Inkdrop expected in CouchDB.  It wasn't terribly difficult to figure out, just took a bit of trial and error. </p>
<p>My script for the conversion is available on GitHub: <a href="https://github.com/vdanen/quiver-to-inkdrop">quiver-to-inkdrop</a>.</p>
<p>This was a nice amusement for me, to be honest.  I always enjoy playing with new software, something I don't get to do as often as I used to (when I wrote for TechRepublic years ago I was playing with new things all the time).  Everything here aside from FreeNAS was new for me and I'd never played with CouchDB before, and I always enjoy doing a bit of Python and hacking things to make them work.  Hopefully there is something interesting or useful here for others to use as well!</p>


             
 
            
            
            







            <hr/>
        </div>
        <section id="article-sidebar" class="span2">
            <h4>Published</h4>
            <time itemprop="dateCreated" datetime="2020-02-23T19:00:00-07:00">Sun 23 February 2020</time>
            <h4>Category</h4>
            <a class="category-link" href="https://vdanen.github.io/categories.html#macos-ref">Macos</a>
            <h4>Tags</h4>
            <ul class="list-of-tags tags-in-article">
                <li><a href="https://vdanen.github.io/tags.html#couchdb-ref">couchdb
                    <span class="superscript">1</span>
</a></li>
                <li><a href="https://vdanen.github.io/tags.html#freenas-ref">freenas
                    <span class="superscript">7</span>
</a></li>
                <li><a href="https://vdanen.github.io/tags.html#inkdrop-ref">inkdrop
                    <span class="superscript">1</span>
</a></li>
            </ul>
<h4>Contact</h4>
<div id="sidebar-social-link">
    <a href="https://twitter.com/vdanen" title="" target="_blank" rel="nofollow noopener noreferrer">
        <svg xmlns="http://www.w3.org/2000/svg" aria-label="Twitter" role="img" viewBox="0 0 512 512"><rect width="512" height="512" rx="15%" fill="#1da1f3"/><path fill="#fff" d="M437 152a72 72 0 0 1-40 12 72 72 0 0 0 32-40 72 72 0 0 1-45 17 72 72 0 0 0-122 65 200 200 0 0 1-145-74 72 72 0 0 0 22 94 72 72 0 0 1-32-7 72 72 0 0 0 56 69 72 72 0 0 1-32 1 72 72 0 0 0 67 50 200 200 0 0 1-105 29 200 200 0 0 0 309-179 200 200 0 0 0 35-37"/></svg>
    </a>
    <a href="https://github.com/vdanen" title="" target="_blank" rel="nofollow noopener noreferrer">
        <svg xmlns="http://www.w3.org/2000/svg" aria-label="GitHub" role="img" viewBox="0 0 512 512"><rect width="512" height="512" rx="15%" fill="#1B1817"/><path fill="#fff" d="M335 499c14 0 12 17 12 17H165s-2-17 12-17c13 0 16-6 16-12l-1-50c-71 16-86-28-86-28-12-30-28-37-28-37-24-16 1-16 1-16 26 2 40 26 40 26 22 39 59 28 74 22 2-17 9-28 16-35-57-6-116-28-116-126 0-28 10-51 26-69-3-6-11-32 3-67 0 0 21-7 70 26 42-12 86-12 128 0 49-33 70-26 70-26 14 35 6 61 3 67 16 18 26 41 26 69 0 98-60 120-117 126 10 8 18 24 18 48l-1 70c0 6 3 12 16 12z"/></svg>
    </a>
    <a href="https://www.linkedin.com/in/vdanen/" title="" target="_blank" rel="nofollow noopener noreferrer">
        <svg xmlns="http://www.w3.org/2000/svg" aria-label="LinkedIn" role="img" viewBox="0 0 512 512" fill="#fff"><rect width="512" height="512" rx="15%" fill="#0077b5"/><circle cx="142" cy="138" r="37"/><path stroke="#fff" stroke-width="66" d="M244 194v198M142 194v198"/><path d="M276 282c0-20 13-40 36-40 24 0 33 18 33 45v105h66V279c0-61-32-89-76-89-34 0-51 19-59 32"/></svg>
    </a>
    <a href="https://infosec.exchange/@vdanen" title="" target="_blank" rel="nofollow noopener noreferrer">
        <svg xmlns="http://www.w3.org/2000/svg" aria-label="Mastodon" role="img" viewBox="0 0 512 512" fill="#fff"><rect width="512" height="512" rx="15%"/><path d="m409 290c-5 24-43 50-85 56-86 11-137-6-137-6 3 13-4 54 70 52 31 0 58-7 58-7l2 27c-51 24-107 15-140 6-67-17-79-90-81-162v-59c0-74 49-96 49-96 50-24 180-22 222 0 0 0 49 22 49 96 0 0 1 55-7 93" fill="#3088d4"/><path d="m358 202v91h-35v-88c0-18-8-27-23-27-18 0-27 11-27 33v47h-34v-47c0-22-9-33-27-33-15 0-23 9-23 27v88h-35v-91c0-18 5-60 52-60 39 0 50 37 50 37s10-37 50-37c45 0 52 42 52 60"/></svg>
    </a>
</div>
            





            





        </section>
</div>
</article>
<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe.
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides.
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo https://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>                    </div>
                    <div class="span1"></div>
                </div>
            </div>
        </div>
<footer>




    <div id="fpowered">
        Powered by: <a href="http://getpelican.com/" title="Pelican Home Page" target="_blank" rel="nofollow noopener noreferrer">Pelican</a>
        Theme: <a href="https://elegant.oncrashreboot.com/" title="Theme Elegant Home Page" target="_blank" rel="nofollow noopener noreferrer">Elegant</a>
    </div>
</footer>            <script src="//code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
        <script src="https://vdanen.github.io/theme/js/elegant.prod.9e9d5ce754.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

    <script>
    (function () {
        if (window.location.hash.match(/^#comment-\d+$/)) {
            $('#comment_thread').collapse('show');
        }
    })();
    window.onhashchange=function(){
        if (window.location.hash.match(/^#comment-\d+$/))
            window.location.reload(true);
    }
    $('#comment_thread').on('shown', function () {
        var link = document.getElementById('comment-accordion-toggle');
        var old_innerHTML = link.innerHTML;
        $(link).fadeOut(200, function() {
            $(this).text('Click here to hide comments').fadeIn(200);
        });
        $('#comment_thread').on('hidden', function () {
            $(link).fadeOut(200, function() {
                $(this).text(old_innerHTML).fadeIn(200);
            });
        })
    })
</script>

    </body>
    <!-- Theme: Elegant built for Pelican
        License : MIT -->
</html>