<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" type="text/css" href="https://vdanen.github.io/theme/css/elegant.prod.9e9d5ce754.css" media="screen">
        <link rel="stylesheet" type="text/css" href="https://vdanen.github.io/theme/css/custom.css" media="screen">
        <link rel="dns-prefetch" href="//fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin>

        <meta name="author" content="Vincent Danen" />

        <meta name="description" content="Copyright © 2003 Jim Colling Originally written for the MandrakeSecure website. The example server box is i686 Mandrake 9.0 with all the updates I can get my hands on. To cut down on network traffic and to ease security, it houses both the OpenLDAP server and Samba. It has also …
" />
        <meta property="og:type" content="article" />
        <meta name="twitter:card" content="summary">


<meta property="og:title" content="Implementing a Samba LDAP Primary Domain Controller Setup "/>
<meta property="og:url" content="https://vdanen.github.io/implementing_a_samba_ldap_primary_domain_controller_setup" />
<meta property="og:description" content="Copyright © 2003 Jim Colling Originally written for the MandrakeSecure website. The example server box is i686 Mandrake 9.0 with all the updates I can get my hands on. To cut down on network traffic and to ease security, it houses both the OpenLDAP server and Samba. It has also …" />
<meta property="og:site_name" content="Annvix" />
<meta property="og:article:author" content="Vincent Danen" />
<meta property="og:article:published_time" content="2008-03-25T12:00:00-06:00" />
<meta name="twitter:title" content="Implementing a Samba LDAP Primary Domain Controller Setup ">
<meta name="twitter:description" content="Copyright © 2003 Jim Colling Originally written for the MandrakeSecure website. The example server box is i686 Mandrake 9.0 with all the updates I can get my hands on. To cut down on network traffic and to ease security, it houses both the OpenLDAP server and Samba. It has also …">

        <title>Implementing a Samba LDAP Primary Domain Controller Setup  · Annvix
</title>
        <link rel="shortcut icon" href="https://vdanen.github.io/theme/images/favicon.ico" type="image/x-icon" />
        <link rel="icon" href="https://vdanen.github.io/theme/images/apple-touch-icon-152x152.png" type="image/png" />
        <link rel="apple-touch-icon" href="https://vdanen.github.io/theme/images/apple-touch-icon.png"  type="image/png" />
        <link rel="apple-touch-icon" sizes="57x57" href="https://vdanen.github.io/theme/images/apple-touch-icon-57x57.png" type="image/png" />
        <link rel="apple-touch-icon" sizes="72x72" href="https://vdanen.github.io/theme/images/apple-touch-icon-72x72.png" type="image/png" />
        <link rel="apple-touch-icon" sizes="76x76" href="https://vdanen.github.io/theme/images/apple-touch-icon-76x76.png" type="image/png" />
        <link rel="apple-touch-icon" sizes="114x114" href="https://vdanen.github.io/theme/images/apple-touch-icon-114x114.png" type="image/png" />
        <link rel="apple-touch-icon" sizes="120x120" href="https://vdanen.github.io/theme/images/apple-touch-icon-120x120.png" type="image/png" />
        <link rel="apple-touch-icon" sizes="144x144" href="https://vdanen.github.io/theme/images/apple-touch-icon-144x144.png" type="image/png" />
        <link rel="apple-touch-icon" sizes="152x152" href="https://vdanen.github.io/theme/images/apple-touch-icon-152x152.png" type="image/png" />
        <link rel="apple-touch-icon" sizes="152x152" href="https://vdanen.github.io/theme/images/apple-touch-icon-180x180.png" type="image/png" />
        <link href="https://vdanen.github.io/recent.atom" type="application/atom+xml" rel="alternate" title="Annvix - Full Atom Feed" />
<script async src="https://www.googletagmanager.com/gtag/js?id=G-5JGVD90SKJ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-5JGVD90SKJ');
</script>



    </head>
    <body>
        <div id="content">
            <div class="navbar navbar-static-top">
                <div class="navbar-inner">
                    <div class="container-fluid">
                        <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </a>
                        <a class="brand" href="https://vdanen.github.io/"><span class=site-name>Annvix</span></a>
                        <div class="nav-collapse collapse">
                            <ul class="nav pull-right top-menu">
                                <li >
                                    <a href=
                                       https://vdanen.github.io
                                    >Home</a>
                                </li>
                                <li ><a href="https://vdanen.github.io/about">About</a></li>
                                <li ><a href="https://vdanen.github.io/documentation">Documentation</a></li>
                                <li ><a href="https://vdanen.github.io/categories">Categories</a></li>
                                <li ><a href="https://vdanen.github.io/tags">Tags</a></li>
                                <li ><a href="https://vdanen.github.io/archives">Archives</a></li>
                                <li><form class="navbar-search" action="https://vdanen.github.io/search" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="container-fluid">
                <div class="row-fluid">
                    <div class="span1"></div>
                    <div class="span10">
<article>
<div class="row-fluid">
    <header class="page-header span10 offset2">
    <h1><a href="https://vdanen.github.io/implementing_a_samba_ldap_primary_domain_controller_setup"> Implementing a Samba <span class="caps">LDAP</span> Primary Domain Controller&nbsp;Setup  </a></h1>
    </header>
</div>

<div class="row-fluid">
    <div class="span2 table-of-content">
        <nav>
        <h4>Contents</h4>
        <div class="toc" id="toc"><div id="toctitle"><h2>Contents</h2></div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="#Upgrading_to_Samba-LDAP"><span class="tocnumber">1</span> <span class="toctext">Upgrading to Samba-<span class="caps">LDAP</span></span></a></li>
<li class="toclevel-1 tocsection-2"><a href="#Adjustments_to_smb.conf"><span class="tocnumber">2</span> <span class="toctext">Adjustments to smb.conf</span></a></li>
<li class="toclevel-1 tocsection-3"><a href="#The_.22Computers.22_OU"><span class="tocnumber">3</span> <span class="toctext">The “Computers” <span class="caps">OU</span></span></a></li>
<li class="toclevel-1 tocsection-4"><a href="#Configuring_the_Perl_Scripts"><span class="tocnumber">4</span> <span class="toctext">Configuring the Perl Scripts</span></a></li>
<li class="toclevel-1 tocsection-5"><a href="#Editing_.2Fetc.2Fldap.conf"><span class="tocnumber">5</span> <span class="toctext">Editing <span>/etc/ldap.conf</span></span></a></li>
<li class="toclevel-1 tocsection-6"><a href="#Security"><span class="tocnumber">6</span> <span class="toctext">Security</span></a></li>
<li class="toclevel-1 tocsection-7"><a href="#Congratulations.21"><span class="tocnumber">7</span> <span class="toctext">Congratulations!</span></a></li>
<li class="toclevel-1 tocsection-8"><a href="#Credits"><span class="tocnumber">8</span> <span class="toctext">Credits</span></a></li>
</ul>
</div>
        </nav>
    </div>
    <div class="span8 article-content">

            <p><small>Copyright © 2003 Jim Colling</small>
</p>
<p>Originally written for the MandrakeSecure website.
</p>

<p>The example server box is i686 <b>Mandrake 9.0</b> with all the updates I can get my hands on. To cut down on network traffic and to ease security, it houses both the <b>OpenLDAP</b> server and <b>Samba</b>. It has also been tested on Mandrake 9.1.
</p>
<p>Speaking of Mandrake 9.1, the reader would be well advised to ensure that all updates have been installed for the OpenLDAP package as some bugs were discovered in the original release of OpenLDAP that comes with Mandrake 9.1.
</p>
<p>As of the writing of this document, Samba 3.0 is still in Alpha stage. There will be differences in implementation / configuration but anyone adequately familiar with 2.2.x will probably be able to figure it out. This document is meant to be an addendum to the <a href="/Using_OpenLDAP_for_User_Authentication" title="Using OpenLDAP for User Authentication">OpenLDAP for Authentication</a> topic and the basic <a class="external text" href="http://www.mandrakeuser.org/docs/connect/index.html#lfs" rel="nofollow">Samba <span class="caps">PDC</span> instructions.</a> Many thanks and all credit due to the authors of these documents. Problems discovered in this document should be forwarded to me at this <a class="external text" href="mailto:jcllings@tsunamicomm.net" rel="nofollow">email </a>address. Go easy on me, I’m new at this. :-)
</p>
<p>Basic procedure for implementing this <span class="caps">HOWTO</span> should be as follows:
</p>
<ol><li> Implement the article on OpenLDAP authentication. This will eliminate the Linux based authentication portion. When finished, return to this <span class="caps">HOWTO</span>. Also don’t bother, just yet, with the section on Samba as we do not yet have it installed. While you are implementing this article read very, *<span class="caps">VERY</span>* carefully. The font is small and I found it quite easy to miss important steps while I was doing it. Also the volume of information provided, while very informative and necessary, increases the odds of an error. I would consider it wise to install the <span class="caps">GUI</span>-<span class="caps">LDAP</span> browser/editor called <b>gq</b> so that you can easily see exactly what is occurring in the database and delete records if you don’t quite get it right the first time. Here is the <a href="/Using_OpenLDAP_for_User_Authentication" title="Using OpenLDAP for User Authentication">topic on OpenLDAP authentication</a>; <b>gq</b> is on the contribs <span class="caps">CD</span>. One might acquire it by going to <a class="external free" href="http://plf.zarb.org/~nanardon" rel="nofollow">http://plf.zarb.org/~nanardon</a> and adding a contrib source to rpmdrake. Having done this facilitates the use of <span style="font-family: courier; color: #2a2c7e; font-size: 13px; font-weight: bold;">urpmi [gq package name]</span>, which automates rpm and is nicer to use. I’ve used <b>gq-0.7.0beta2-1mdk</b> on the original Mandrake 9.0 box which I found at <a class="external text" href="http://speakeasy.rpmfind.net/linux/RPM/" rel="nofollow">speakeasy.</a> Note that migrating old <b>userid</b>‘s over to <b>samba-ldap</b> may be something to put off until a fully functioning samba-ldap system has been established. In this way, we will also be able to take advantage of the special scripts provided for this purpose. At least two accounts will be required immediately for testing, however. These are <b>Administrator</b> (or <i>an</i> administrator) and a regular unprivileged user.</li>
<li> Performance of a certain amount of complexity management will also be worth while. This material can cause headaches, so take things one step at a time. In the same spirit, if you’ve never installed a Samba <span class="caps">PDC</span> <i>without</i> <span class="caps">LDAP</span>, it is probably wise to give that a try before moving on to this, the next level. The basic process for doing this can be found in the docs section of <a class="external text" href="http://www.mandrakeuser.org/docs/connect/index.html#lfs" rel="nofollow">mandrakeuser. org</a> and can be performed with OpenLDAP installed and configured without any harm. You can get your Samba rpm packages from <a class="external text" href="http://download.samba.org/samba/ftp/Binary_Packages/Mandrake/" rel="nofollow">download.samba.org</a>. While they will be needed in the next step, <i>do not</i> install the <span class="caps">LDAP</span> packages for this stage. Use the others instead.</li>
<li> Ensure that you have the NetBIOS ports 136,137 and 138 available to both the OpenLDAP / Samba server and the client systems. While doing this, it may also be desirable to check on OpenLDAP ports 389 and 636. Especially if your OpenLDAP and Samba servers are not on the same box. Don’t forget to start the daemons first as shown below.</li></ol>
<pre>
[root@ldap]# service ldap start; service smb start
</pre>
<p>Most network people will say that having one box performing both the Firewall and File Server functions is a poor security practice and they are correct. This may not be practical, reasonable or possible on many systems, however. Home networks, for example, may find themselves in situations similar to my own. I am not only poorly funded but I am also situated behind an Internet Service Provider’s hard-core, supra-draconian firewall and bandwidth management system. Such is the price one finds oneself paying for high speed access in a small rural college town.
</p>
<p>But I digress. As a result of the above, I’ve provided a commented example [rules.txt /etc/shorewall/rules] file here. How useful this is depends on much, so your mileage may vary.
</p>
<p><span class="caps">OK</span>, you’ve made it this far, now you are ready for cross-platform samba-ldap!! Because we’ve performed step 1, we already have a working and at least minimally populated OpenLDAP database and, because we have performed step 2, we already have a good idea of what settings are required to get a Samba <span class="caps">PDC</span> server to authenticate users for Windows. We are still missing some things however.
</p>
<ul><li> We may have to upgrade to our new samba-ldap packages from the old Samba packages.</li>
<li> We have to make the same adjustments to smb.conf as mentioned in the Samba <span class="caps">PDC</span> article with several additional adjustments for <span class="caps">LDAP</span>.</li>
<li> We need to make some design decisions about where in the database we want our computer accounts placed.</li>
<li> We must configure the Perl scripts that will manage our accounts in the <span class="caps">LDAP</span> database.</li>
<li> We need to make one minor change to _/etc/ldap.conf_</li>
<li> Security must be tailored to reduce the new system’s exposure.</li></ul>
<h2><span class="mw-headline" id="Upgrading_to_Samba-LDAP">Upgrading to Samba-<span class="caps">LDAP</span></span></h2>
<p>In order to perform our upgrade, new samba-ldap packages can be retrieved from the same location mentioned before. When we do this, the old configuration files will be copied to a new file named <span style="font-family: courier; color: #891214; font-style: italic; font-size: 13px; font-weight: bold;">[old file name].rpmsave</span>.
</p>
<p>If you install an external source (ie. a Sambaldap source via the <span class="caps">PLF</span> pages mentioned momentarily), then use this command:
</p>
<pre>
[root@ldap]# urpmi samba-server-ldap
</pre>
<p>If would rather not install an external source, you will have to go to <a class="external text" href="http://download.samba.org/samba/ftp/Binary_Packages/Mandrake/" rel="nofollow">download.samba.org</a> and download and install them by hand using:
</p>
<pre>
[root@ldap]# rpm -U [package name]
</pre>
<p>The real difference is that urpmi takes care of the dependencies automatically. The above source can be added from <a class="external text" href="http://plf.zarb.org/~nanardon/?minor=1" rel="nofollow">plf.zarb.org</a>.
</p>
<h2><span class="mw-headline" id="Adjustments_to_smb.conf">Adjustments to smb.conf</span></h2>
<p>Next we need to refer back to this section on Samba in the <a href="/Using_OpenLDAP_for_User_Authentication" title="Using OpenLDAP for User Authentication">OpenLDAP Auth</a> topic. Follow the instructions but with these caveats:
</p>
<p>The article suggests the following settings:
</p>
<pre>
ldap admin dn = cn=root,dc=mylan,dc=net
ldap server = 127.0.0.1
ldap suffix = dc=mylan,dc=net
ldap port = 389
ldap ssl = start_tls
</pre>
<p>We don’t really need the overhead that accompanies encryption between two servers on the same system. If a cracker can gain access to your system at this level then likely they can get your encryption codes also, rendering the point moot. If your <span class="caps">LDAP</span> server is not on the same machine you would definitely want this on.
</p>
<p>More specifically, if you have:
</p>
<pre>
ldap ssl = start_tls
</pre>
<p>then you should set <b>ldap port = 389</b>. If you have:
</p>
<pre>
ldap ssl = on
</pre>
<p>then you should set <b>ldap port = 636</b>. Finally, if you have:
</p>
<pre>
ldap ssl = off
</pre>
<p>or
</p>
<pre>
#ldap ssl = start_tls
</pre>
<p>(commented out), then you should set <b>#ldap port = 389</b> (also commented out).
</p>
<p>Again, since both our Samba and our OpenLDAP servers are on the same box, we will go with the last one.
</p>
<p>Settings specific to a particular versions of Microsoft’s <span class="caps">OS</span>’s are dealt with in the basic Samba <span class="caps">PDC</span> article and are consequently outside the scope of this <span class="caps">HOWTO</span>.
</p>
<p>Remember to pay close attention to the comments in the _smb.conf_ file. They can be quite educational. All in all then, the settings in <span style="font-family: courier; color: #891214; font-style: italic; font-size: 13px; font-weight: bold;">smb.conf</span> to be added to those found in the basic Samba <span class="caps">PDC</span> article are:
</p>
<pre>
#in the global section:
[global]
ldap admin dn = cn=root,dc=mylan,dc=net
ldap server = 127.0.0.1
ldap suffix = dc=mylan,dc=net
#ldap ssl = start_tls
add user script = /usr/share/samba/scripts/smbldap-useradd.pl -w -d /dev/null -g machines \
 -c 'Machine Account' -s /bin/false %u
domain admin group = root Administrator @adm @Administrators @wheel
</pre>
<p>(Note the line wrap in the above example; this should all be on one line in your file.)
</p>
<p>When Samba goes to manipulate or read the OpenLDAP database, it needs to have an administrative level of access. This is what the <span style="font-family: courier; color: #2a2c7e; font-size: 13px; font-weight: bold;">ldap admin dn</span> setting is used for, but have you noticed something missing? No password! Just like in a normal Samba <span class="caps">PDC</span> implementation we need to use:
</p>
<pre>
[root@ldap]# smbpasswd -w [password]
</pre>
<p>to store the password in <span style="font-family: courier; color: #891214; font-style: italic; font-size: 13px; font-weight: bold;">/etc/samba/secrets.tdb</span>.
</p>
<p>In Windows Networking, computers are treated like users. They have their own <b>userid</b>‘s. The <span style="font-family: courier; color: #2a2c7e; font-size: 13px; font-weight: bold;">add user script</span> line, mentioned above, will cause a machine that successfully joins the domain to be added to the <span class="caps">LDAP</span> database automatically. This will ease management of Computer accounts.
</p>
<p>Exploring the various other Perl scripts available in the <span style="font-family: courier; color: #891214; font-style: italic; font-size: 13px; font-weight: bold;">/usr/share/samba/scripts</span> directory might also be wise. Some of them do require minor changes. Take <span style="font-family: courier; color: #891214; font-style: italic; font-size: 13px; font-weight: bold;">import_smbpasswd</span>, for example. It requires changes to the section displayed below that reflect the system as it actually is:
</p>
<pre>
#################################################
## set these to a value appropriate for your site
##

$DN="ou=people,dc=mylan,dc=net";
$ROOTDN="cn=root,dc=mylan,dc=net";
# If you use perl special character  in your
# rootpw, escape them:
# $rootpw = "secr\@t" instead of $rootpw = "secr@t"
$rootpw = "n0pass";
$LDAPSERVER="scooby";

##
## end local site variables
#################################################
</pre>
<p>Since the script requires the $rootpw password value in clear text, the file is only readable by root. This is for your own protection, but if you use the script, please remember to remove the password once you have imported all your users. The fewer plain text passwords laying around the better.
</p>
<p>The <span style="font-family: courier; color: #2a2c7e; font-size: 13px; font-weight: bold;">domain admin group</span> setting in <span style="font-family: courier; color: #891214; font-style: italic; font-size: 13px; font-weight: bold;">/etc/smb.conf</span> is a list of users and groups of users who are allowed to administer the system. The list above is an example of users and groups you may wish to include. Note that the <b>@</b> symbol is used to tag groups so that the system can tell the difference between a user and a group. By default, only people who are listed here, or in one of the groups listed here, can add users or machines to the system.
</p>
<h2><span class="mw-headline" id="The_.22Computers.22_OU">The “Computers” <span class="caps">OU</span></span></h2>
<p>Next, we have to make an adjustment to our OpenLDAP database. Specifically, we will need an additional organizational unit (ou).
</p>
<p>So far we are keeping our users under the <b>People</b> ou but we still need a place for our computer accounts. We’ll call this place <b>ou=Computers,sc=mylan,dc=net</b> as shown below. Create a text file with the following contents named <span style="font-family: courier; color: #891214; font-style: italic; font-size: 13px; font-weight: bold;">ComputersOU.ldif</span>:
</p>
<pre>
dn: ou=Computers,dc=mylan,dc=net
ou: Computers
objectClass: top
objectClass: organizationalUnit
objectClass: domainRelatedObject
associatedDomain: mylan.net
</pre>
<p>Now, as root, use this command to add it to the system:
</p>
<pre>
[root@ldap]# ldapadd -x -D "dc=mylan,dc=net" -W -f ComputersOU.ldif
</pre>
<p>As a side note, I will mention that amongst user accounts of any sort (i.e. whether it be a computer account or a living breathing user) the <span style="font-family: courier; color: #2a2c7e; font-size: 13px; font-weight: bold;">uidNumber</span> must be unique. For example, there should be only one <span style="font-family: courier; color: #2a2c7e; font-size: 13px; font-weight: bold;">uidNumber: 501</span> anywhere in the <b>dc=mylan,dc=net</b> domain.
</p>
<h2><span class="mw-headline" id="Configuring_the_Perl_Scripts">Configuring the Perl Scripts</span></h2>
<p>Let’s talk about the script configuration file, <span style="font-family: courier; color: #891214; font-style: italic; font-size: 13px; font-weight: bold;">/etc/samba/smbldap_conf.pm</span>. This file provides information about how you want things to the Perl scripts we will be using to manage our system. Now again, this is another well commented script file. Reading these comments, as before, can prove highly educational. Open it using your favourite text editor and set the following:
</p>
<pre>
$slaveLDAP = "127.0.0.1";

$masterLDAP = "127.0.0.1";

$suffix = "dc=mylan,dc=net";

$usersou = q(People);

$computersou = q(Computers);

$groupsou = q(Group);

#Where mylan is the name of our domain. It should be the same as the
#workgroup setting in '/etc/smb.conf'
$binddn = "cn=root,dc=mylan,dc=net";

$bindpasswd = "place password belonging to the binddn above, here";

$_userLoginShell = q(/bin/bash);

$_userHomePrefix = q(/home/);

#All users must belong to at least one group.  On my system this group
#is called dusers and the gidNumber is entered below.
$_defaultUserGid = 1002;

#All computer accounts must also belong to at least one group.
#On my system this group is called "Machines" and the gidNumber is
#entered below.
$_defaultComputerGid = 421;
#Note: Use a drive letter below that is not being used, otherwise
#there will be trouble. It has to be unique. There can't be two named Z:

#I'm going to use 'Z:' but you can use anything that is free on all
#systems.
$_userHomeDrive = q(Z:);
</pre>
<p>Now that we can use our scripts, we need to ensure that we have an <b>Administrator</b> account, an <b>adm</b> group, a <b>dusers</b> group, a <b>Machines</b> group and at least one unprivileged user. The unprivileged user I am using is <b>jcolling</b>. Those who lean on the Unix side may certainly use <b>root</b> instead of <b>Administrator</b>, if they wish.
</p>
<p>To check for the groups, you can do as I have done:
</p>
<pre>
[root@ldap]# smbldap-groupshow [name of group]
</pre>
<p>For example:
</p>
<pre>
[root@ldap]# smbldap-groupshow adm
dn: cn=adm,ou=Group,dc=mylan,dc=net
objectClass: posixGroup
cn: adm
gidNumber: 1001
</pre>
<p>Checking for the users is only slightly different. Don’t be alarmed if you see the users passwords though. Due to the <b>$binddn = “dc=mylan,dc=net”</b> setting, the scripts access the system as root and are entitled to them. Just remember to clear your screen afterwords with the <span style="font-family: courier; color: #2a2c7e; font-size: 13px; font-weight: bold;">clear</span> command (or <span class="caps">CTRL</span>-L):
</p>
<pre>
[root@ldap]# smbldap-usershow Administrator
dn: uid=Administrator,ou=People,dc=mylan,dc=net
sn: Administrator
mail: root@mylan.net
mailForwardingAddress: Administrator@mail.mylan.net
mailHost: mail.mylan.net
objectClass: mailRecipient
objectClass: person
objectClass: organizationalPerson
objectClass: inetOrgPerson
objectClass: posixAccount
objectClass: top
objectClass: kerberosSecurityObject
objectClass: shadowAccount
objectClass: sambaAccount
userPassword:: [I've deleted this for security reasons]
shadowLastChange: 12110
shadowMax: 99999
shadowWarning: 7
krbName: Administrator@MYLAN.NET
loginShell: /bin/bash
uidNumber: 1000
homeDirectory: /home/Administrator
gecos: Administrator
gidNumber: 1001
mailLocalAddress: root@mylan.net
uid: Administrator
pwdLastSet: 1046627953
logonTime: 0
logoffTime: 2147483647
kickoffTime: 2147483647
pwdCanChange: 0
pwdMustChange: 2147483647
displayName: Administrator
cn: Administrator
rid: 3000
primaryGroupID: 3003
lmPassword: [I've deleted this for security reasons]
ntPassword: [I've deleted this for security reasons]
acctFlags: [UX         ]

[root@ldap]# clear
</pre>
<p>If you are missing users or groups they are easily added using <span style="font-family: courier; color: #2a2c7e; font-size: 13px; font-weight: bold;">smbldap-groupadd</span> and <span style="font-family: courier; color: #2a2c7e; font-size: 13px; font-weight: bold;">smbldap-useradd</span> as shown below. Just remember to keep the default gidNumbers straight in <span style="font-family: courier; color: #891214; font-style: italic; font-size: 13px; font-weight: bold;">/etc/samba/smbldap_conf.pm</span>.
</p>
<p>The commands to add each user/group are as follows:
</p>
<pre>
[root@ldap]# smbldap-groupadd adm
[root@ldap]# smbldap-groupadd Machines
[root@ldap]# smbldap-groupadd dusers
[root@ldap]# smbldap-useradd -a -P -m -E '' -F '' -g adm -G dusers Administrator
[root@ldap]# smbldap-useradd -a -P -m -E '' -F '' -g dusers unpriviledgeduser
</pre>
<p>Note that I’ve been using dusers because users is already a local group in <span style="font-family: courier; color: #891214; font-style: italic; font-size: 13px; font-weight: bold;">/etc/group</span>.
</p>
<h2><span class="mw-headline" id="Editing_.2Fetc.2Fldap.conf">Editing /etc/ldap.conf</span></h2>
<p><span class="caps">OK</span>, now we have a new (ou) which we have yet to set up access for. Fixing this situation will entail editing <span style="font-family: courier; color: #891214; font-style: italic; font-size: 13px; font-weight: bold;">/etc/ldap.conf</span>.
</p>
<p>Remember these lines in <span style="font-family: courier; color: #891214; font-style: italic; font-size: 13px; font-weight: bold;">/etc/ldap.conf</span> from the OpenLDAP Auth article?
</p>
<pre>
nss_base_passwd         ou=People,dc=mylan,dc=net?one
nss_base_shadow         ou=People,dc=mylan,dc=net?one
nss_base_group          ou=Group,dc=mylan,dc=net?one
nss_base_hosts          ou=Hosts,dc=mylan,dc=net?one
</pre>
<p>On the <span class="caps">LDAP</span> server machine, and only on the <span class="caps">LDAP</span> server machine, we need to change the first one to read:
</p>
<pre>
nss_base_passwd         dc=mylan,dc=net?sub
</pre>
<p>We need to do this because if we don’t, the system will not be able to find the Computer accounts which don’t live in the <b>People</b> organizational unit. When we add them, they will live in the <b>Computers</b> organizational unit and when Samba goes hunting for them we want it to start at the base and continue down the directory tree so that it finds <span class="caps">ALL</span> user accounts.
</p>
<h2><span class="mw-headline" id="Security">Security</span></h2>
<p>Security is our last issue. Log into Linux as the unprivileged user and from the command line execute:
</p>
<pre>
[root@ldap]# ldapsearch -LL -H ldap://localhost -b"dc=mylan,dc=net" -x "(uid=Administrator)" \
| grep Password
</pre>
<p>Whoa! The unprivileged user can see <i>all</i> the Windows <span class="caps">NT</span> and Lanmanager passwords! We have <i>got</i> to fix this. Fortunately, the fix is as simple as altering the first line of <span style="font-family: courier; color: #891214; font-style: italic; font-size: 13px; font-weight: bold;">/etc/slapd.access.conf</span>. It used to read:
</p>
<pre>
access to dn=".*,dc=mylan,dc=net" attr=userPassword
</pre>
<p>…but now we should change it to this to secure those passwords:
</p>
<pre>
access to dn=".*,dc=mylan,dc=net" attr=userPassword,lmPassword,ntPassword
</pre>
<p>Now the OpenLDAP server needs to be restarted. We do this in the same manner as mentioned in the OpenLDAP Auth article, namely:
</p>
<pre>
[root@ldap]# service ldap restart
</pre>
<p>To double check those password attributes, you man now wish to run the <span style="font-family: courier; color: #2a2c7e; font-size: 13px; font-weight: bold;">ldapsearch</span> command again. You shouldn’t see any passwords this time.
</p>
<p>Now the last major security issue we have to worry about is securing the server.
</p>
<p>If you have a firewall running on this box, shut it down momentarily and enter the <span style="font-family: courier; color: #2a2c7e; font-size: 13px; font-weight: bold;">netstat</span> command shown below and notice any connections from Samba’s ports (i.e. ports 137 - 139) open to the Internet.
</p>
<pre>
[root@ldap]# netstat -ntupl | grep smbd; netstat -ntupl | grep nmbd
</pre>
<p>Your output will be different but should resemble mine:
</p>
<pre>
[root@ldap]# netstat -ntupl | grep smbd; netstat -ntupl | grep nmbd
tcp        0      0 0.0.0.0:139             0.0.0.0:* LISTEN      28174/smbd
udp        0      0 208.152.4.207:137       0.0.0.0:*             28184/nmbd
udp        0      0 192.168.1.253:137       0.0.0.0:*             28184/nmbd
udp        0      0 0.0.0.0:137             0.0.0.0:*             28184/nmbd
udp        0      0 208.152.4.207:138       0.0.0.0:*             28184/nmbd
udp        0      0 192.168.1.253:138       0.0.0.0:*             28184/nmbd
udp        0      0 0.0.0.0:138             0.0.0.0:*             28184/nmbd
</pre>
<p>Now I know that eth0 (a.k.a 208.152.4.207, in my case ) is non-local (i.e. the Internet) and eth1 ( a.k.a 192.168.1.253 ) is my local network. This is not secure because folks from outside my network can talk to my Samba server over eth0. I can secure it by making two minor changes to <span style="font-family: courier; color: #891214; font-style: italic; font-size: 13px; font-weight: bold;">/etc/samba/smb.conf</span>. In <span style="font-family: courier; color: #891214; font-style: italic; font-size: 13px; font-weight: bold;">smb.conf</span> you will find two lines similar to these:
</p>
<pre>
#  hosts allow = 192.168.1. 192.168.2. 127.

;   interfaces = 192.168.12.2/24 192.168.13.2/24

#Change the first one to read:

   hosts allow = 192.168.1. 127.

#and the second one to read:

   interfaces = 192.168.1.253/24

#and lastly add this line, also, in the global section:

        bind interfaces only = yes
</pre>
<p>Ensure that either reverse <span class="caps">DNS</span> lookups work or that you have a good <span style="font-family: courier; color: #891214; font-style: italic; font-size: 13px; font-weight: bold;">/etc/hosts</span> file, otherwise you may get weird errors on the samba side, and no connection on the windows side when using <span style="font-family: courier; color: #2a2c7e; font-size: 13px; font-weight: bold;">hosts allow</span>.
</p>
<p>Now restart both the firewall and the Samba server and let’s take a second look with the <span style="font-family: courier; color: #2a2c7e; font-size: 13px; font-weight: bold;">netstat</span> command again:
</p>
<pre>
[root@ldap]# netstat -ntupl | grep smbd; netstat -ntupl | grep nmbd
</pre>
<p>Mine now gives this output. Notice that <span class="caps">IP</span> address 208.152.4.207 is no longer displayed, indicating that access is no longer available to that <span class="caps">IP</span> address:
</p>
<pre>
[root@ldap]# netstat -ntupl | grep smbd; netstat -ntupl | grep nmbd
tcp        0      0 0.0.0.0:139             0.0.0.0:* LISTEN     28311/smbd
udp        0      0 192.168.1.253:137       0.0.0.0:*            28321/nmbd
udp        0      0 0.0.0.0:137             0.0.0.0:*            28321/nmbd
udp        0      0 192.168.1.253:138       0.0.0.0:*            28321/nmbd
udp        0      0 0.0.0.0:138             0.0.0.0:*            28321/nmbd
</pre>
<h2><span class="mw-headline" id="Congratulations.21">Congratulations!</span></h2>
<p>You’ve just finished your samba-ldap <span class="caps">PDC</span>! Remember to make any necessary adjustments to your client systems in accordance with standard Samba <span class="caps">PDC</span> procedure then use the <b>Administrator</b> user’s <b>userid</b> and password to add your machine to the domain.
</p>
<p>According to discussion on the OpenLDAP lists, these next comments do not pertain to the smbldap-tools package (i.e. the Perl scripts in <span style="font-family: courier; color: #891214; font-style: italic; font-size: 13px; font-weight: bold;">/usr/share/samba/scripts</span>) but they are important if you are going to write scripts in languages other than Perl. Now, if you have things set such that you never have more than one entity, either an administrator or a script etc., making changes at one time you may safely ignore these issues. Otherwise you may be interested in the information below.
</p>
<p>OpenLDAP is a trimmed down Object Orientated <span class="caps">DBMS</span> as opposed to an <span class="caps">RDBMS</span> or Relational <span class="caps">DBMS</span>. Trimmed down means that some of the functions one might normally find in a <span class="caps">DBMS</span> have been omitted. This lack of function is not by any means a bad thing as it facilitates speed and compatibility across different versions of <span class="caps">LDAP</span>. However because of this, some creativity is frequently required when writing scripts that manage the system.
</p>
<p>Specific problems I have encountered include the inability to efficiently retrieve the largest uidNumber in the database and the lack of record-locking facilities. The former can be resolved by adding the uidPool and gidPool objectClass’es to the proxyuser. One then uses these to store the largest uidNumber or gidNumber so that we don’t have to query the entire system to retrieve them. The later can be resolved by using a data structure called a <i>semaphore</i> in our local scripts. Also, by specifying the entire dn, including the value to be modified, in the script such that if the value is modified by another script before we can finish our modification, our modification will fail because the dn no longer exists. Semaphores exist in Perl, <span class="caps">PHP</span> and also I believe in Python. To find out more about them, use an on-line reference appropriate to the script language you wish to use. Most of these explain the concept sufficiently so that even one who does not know the script language in question can understand it.
</p>
<h2><span class="mw-headline" id="Credits">Credits</span></h2>
<p>The amount of help I received in compiling this article was phenomenal. When I started, I was new to authentication, OpenLDAP and Samba <span class="caps">PDC</span>’s. The guidance I received from the folks listed here was invaluable. Doubly so since this <span class="caps">HOWTO</span> is a direct contribution to my graduate thesis on Cross-platform user authentication. I owe a great number of people thanks however it is likely that I will not be able to list them all. The listed sources then, are those to whom I feel especially indebted.
</p>
<ul><li> Buchan Milne</li>
<li> Vincent Danen</li>
<li> The online Samba Community</li>
<li> The online OpenLDAP Community</li></ul>
<p><small>Copyright © 2003 Jim Colling</small>
</p>
            







        </div>
    </div>
    </article>
<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe.
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides.
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo https://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>                    </div>
                    <div class="span1"></div>
                </div>
            </div>
        </div>
<footer>
    <div>
        Copyright &copy; 2023 Vincent Danen
    </div>




    <div id="fpowered">
        Powered by: <a href="http://getpelican.com/" title="Pelican Home Page" target="_blank" rel="nofollow noopener noreferrer">Pelican</a>
        Theme: <a href="https://elegant.oncrashreboot.com/" title="Theme Elegant Home Page" target="_blank" rel="nofollow noopener noreferrer">Elegant</a>
    </div>
</footer>            <script src="//code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
        <script src="https://vdanen.github.io/theme/js/elegant.prod.9e9d5ce754.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

    <script>
    (function () {
        if (window.location.hash.match(/^#comment-\d+$/)) {
            $('#comment_thread').collapse('show');
        }
    })();
    window.onhashchange=function(){
        if (window.location.hash.match(/^#comment-\d+$/))
            window.location.reload(true);
    }
    $('#comment_thread').on('shown', function () {
        var link = document.getElementById('comment-accordion-toggle');
        var old_innerHTML = link.innerHTML;
        $(link).fadeOut(200, function() {
            $(this).text('Click here to hide comments').fadeIn(200);
        });
        $('#comment_thread').on('hidden', function () {
            $(link).fadeOut(200, function() {
                $(this).text(old_innerHTML).fadeIn(200);
            });
        })
    })
</script>

    </body>
    <!-- Theme: Elegant built for Pelican
        License : MIT -->
</html>