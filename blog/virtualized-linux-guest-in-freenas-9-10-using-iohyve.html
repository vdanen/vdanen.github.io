<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" type="text/css" href="https://vdanen.github.io/theme/css/elegant.prod.9e9d5ce754.css" media="screen">
        <link rel="stylesheet" type="text/css" href="https://vdanen.github.io/theme/css/custom.css" media="screen">

        <link rel="dns-prefetch" href="//fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin>

        <meta name="author" content="Vincent Danen" />

        <meta property="og:type" content="article" />
        <meta name="twitter:card" content="summary">

<meta name="keywords" content="iohyve, freenas, centos, ipa, Bsd, " />

<meta property="og:title" content="Virtualized Linux guest in FreeNAS 9.10 using iohyve "/>
<meta property="og:url" content="https://vdanen.github.io/blog/virtualized-linux-guest-in-freenas-9-10-using-iohyve.html" />
<meta property="og:description" content="During the day I&#39;m a manager of one of the greatest security teams on the planet (in my biased estimation), but at night (and random times throughout the day), I&#39;m a sysadmin tinkerer. There&#39;s just something about goofing off with operating systems that appeals to me; this is likely what …" />
<meta property="og:site_name" content="Annvix" />
<meta property="og:article:author" content="Vincent Danen" />
<meta property="og:article:published_time" content="2017-03-24T16:00:00-06:00" />
<meta name="twitter:title" content="Virtualized Linux guest in FreeNAS 9.10 using iohyve ">
<meta name="twitter:description" content="During the day I&#39;m a manager of one of the greatest security teams on the planet (in my biased estimation), but at night (and random times throughout the day), I&#39;m a sysadmin tinkerer. There&#39;s just something about goofing off with operating systems that appeals to me; this is likely what …">

        <title>Virtualized Linux guest in FreeNAS 9.10 using iohyve  · Annvix
</title>
        <link href="https://vdanen.github.io/recent.atom" type="application/atom+xml" rel="alternate" title="Annvix - Full Atom Feed" />



    </head>
    <body>
        <div id="content">
            <div class="navbar navbar-static-top">
                <div class="navbar-inner">
                    <div class="container-fluid">
                        <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </a>
                        <a class="brand" href="https://vdanen.github.io/"><span class=site-name>Annvix</span></a>
                        <div class="nav-collapse collapse">
                            <ul class="nav pull-right top-menu">
                                <li >
                                    <a href=
                                       https://vdanen.github.io
                                    >Home</a>
                                </li>
                                <li ><a href="https://vdanen.github.io/about.html">About</a></li>
                                <li ><a href="https://vdanen.github.io/documentation.html">Documentation</a></li>
                                <li ><a href="https://vdanen.github.io/categories.html">Categories</a></li>
                                <li ><a href="https://vdanen.github.io/tags.html">Tags</a></li>
                                <li ><a href="https://vdanen.github.io/archives.html">Archives</a></li>
                                <li><form class="navbar-search" action="https://vdanen.github.io/search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="container-fluid">
                <div class="row-fluid">
                    <div class="span1"></div>
                    <div class="span10">
<article itemscope>
<div class="row-fluid">
    <header class="page-header span10 offset2">
        <h1>
            <a href="https://vdanen.github.io/blog/virtualized-linux-guest-in-freenas-9-10-using-iohyve.html">
                Virtualized Linux guest in FreeNAS 9.10 using iohyve
            </a>
        </h1>
    </header>
</div>

<div class="row-fluid">
        <div class="span8 offset2 article-content">
            
            <p><img alt="Image" src="https://vdanen.github.io/images/freenas.jpg">During the day I'm a manager of one of the greatest security teams on the planet (in my biased estimation), but at night (and random times throughout the day), I'm a sysadmin tinkerer.  There's just something about goofing off with operating systems that appeals to me; this is likely what caused me to devote five years of my life to working on Annvix back in the day.</p>
<p>I've been running a local <a href="https://www.freeipa.org/page/Main_Page">IPA</a> install for quite a few years, but because you really need IPA to run on its own dedicated system (and given I have enough machines running in this house) I've been using KVM to handle the virtualization of an IPA server.  IPA is really cool and allowed me to discard my homegrown LDAP+Kerberos setup for something with some enterprise gusto to manage authentication, identification, and authorization policies for my home network (insert obligatory comment about overkill here).  I started using IPA on CentOS 6 and a year ago moved both guest and host to CentOS 7 which is working pretty good other than, for some odd reason, python is randomly segfaulting at times.  I don't know what the cause is, I've filed abrt reports, and it's a concern when the language that your system updater is based on decides to start crashing before installing updates or, even worse, during the installation of updates and making a mess of things (this does <em>not</em> make RPM happy!).  The oddest thing is that none of the other CentOS 7 systems (on bare metal) exhibit this behaviour.</p>
<p>The other problem is if my IPA server decides to tip over, I don't have a failover setup (again this being at home).  So while I was thinking about the best way to stand up another IPA server as a replicating slave to then promote it to the master and migrate away from whatever is causing all these nasty segaults, I was reminded by FreeNAS that an update was available for it, and I started thinking about jails and whether they would run Linux.  After starting down the rabbit trail, I found out about <a href="ttps://github.com/pr1ntf/iohyve">iohyve</a> which is a FreeBSD (what FreeNAS is based on) <a href="https://en.wikipedia.org/wiki/Bhyve">bhyve</a> manager.  Byhve is a hypervisor that runs on FreeBSD, basically like KVM (which I've been using) or OpenVZ (which I've used with VPS hosting), or Xen.</p>
<p>So bhyve is for FreeBSD what KVM is for Linux.  And this is where the sysadmin/tinkerer/geek in me thinks "cool" and away disappears a weekend.</p>
<p>For the purposes of this post/tutorial, you need to be running FreeNAS 9.10 (you can probably do this easily enough with FreeBSD, but I've not tried).  There is also documentation on <a href="https://doc.freenas.org/9.10/jails.html#using-iohyve">Using iohyve</a>.</p>
<p>From your FreeNAS system you need to know your ethernet interface name (in the web UI go to <strong>Network -&gt; Network Interfaces</strong>, in my case <em>em0</em>) and the storage pool name (<strong>Storage -&gt; Volumes</strong>, in my case the pool is named <em>storage</em>).  The actual setup of iohyve needs to be done as root over SSH, so you'll need that running as well.</p>
<p>As root, we need to create the environment iohyve requires.   I used the following commands to create the pool for its use:</p>
<div class="highlight"><pre><span></span><code><span class="cp"># iohyve setup pool=storage kmod=1 net=em0</span>
<span class="n">Setting</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="n">iohyve</span><span class="w"> </span><span class="n">pool</span><span class="p">...</span>
<span class="n">On</span><span class="w"> </span><span class="n">FreeNAS</span><span class="w"> </span><span class="n">installation</span><span class="p">.</span>
<span class="n">Checking</span><span class="w"> </span><span class="n">for</span><span class="w"> </span><span class="n">symbolic</span><span class="w"> </span><span class="n">link</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="o">/</span><span class="n">iohyve</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">iohyve</span><span class="p">...</span>
<span class="n">Symbolic</span><span class="w"> </span><span class="n">link</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="o">/</span><span class="n">iohyve</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">iohyve</span><span class="w"> </span><span class="n">successfully</span><span class="w"> </span><span class="n">created</span><span class="p">.</span>
<span class="n">Loading</span><span class="w"> </span><span class="n">kernel</span><span class="w"> </span><span class="n">modules</span><span class="p">...</span>
<span class="n">bridge0</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">already</span><span class="w"> </span><span class="n">enabled</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">machine</span><span class="p">...</span>
<span class="n">Setting</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="n">correct</span><span class="w"> </span><span class="n">sysctl</span><span class="w"> </span><span class="n">value</span><span class="p">...</span>
<span class="n">net</span><span class="p">.</span><span class="n">link</span><span class="p">.</span><span class="n">tap</span><span class="p">.</span><span class="n">up_on_open</span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="mi">1</span>
</code></pre></div>

<p>This tells iohyve to install the required ZFS datasets and kernel modules.  We use <code>kmod=1</code> to tell iohyve to load the required kernel module, <code>pool=storage</code> tells it which pool to use for files (in this case, <em>storage</em>) and <code>net=em0</code> sets up the network bridge to this interface (iohyve can only be bound to a single interface).  You can use multiple pools for iohyve, however I only have one pool on the system.</p>
<p>Next, you need to create a few tunables in FreeNAS.  Heading back to the web UI, go to <strong>System -&gt; Tunables</strong> and create the following two tunables:</p>
<ul>
<li>variable: <strong>iohyve_enable</strong>, values: <strong>YES</strong>, type: <strong>rc_conf</strong></li>
<li>variable: <strong>iohve_flags</strong>, values: <strong>kmod=1 net=em0</strong>, type: <strong>rc_conf</strong></li>
</ul>
<p>The <strong>iohyve_enable</strong> variable tells FreeNAS to load iohyve support at boot, and the <strong>iohyve_flags</strong> are the same kmod and net options we used when setting up iohyve initially.</p>
<p>The next step is to download an ISO image for iohyve to use for installing a virtual machine.  In my case, I want to run CentOS 7.  There are plenty of <a href="http://isoredirect.centos.org/centos/7/isos/x86_64/CentOS-7-x86_64-Minimal-1611.iso">mirrors</a> to choose from for the minimal ISO which is probably what you want since you can install any specific software required using yum after it's installed.</p>
<div class="highlight"><pre><span></span><code><span class="gh">#</span> iohyve fetch http://centos.mirror.iweb.ca/7/isos/x86_64/CentOS-7-x86_64-Minimal-1611.iso
Fetching http://centos.mirror.iweb.ca/7/isos/x86_64/CentOS-7-x86_64-Minimal-1611.iso...
/iohyve/ISO/CentOS-7-x86_64-Minimal-1611.iso/C100% of  680 MB    9 MBps 01m08s
</code></pre></div>

<p>You need to use iohyve to fetch the ISO image (somewhat annoyingly) so you can't just copy an existing ISO over (although I believe you can do a fetch over NFS or provide it locally via HTTP from another system on your network).</p>
<p>Once you have the ISO downloaded, you can configure a new virtual machine.  Check to make sure you have the ISO available:</p>
<div class="highlight"><pre><span></span><code><span class="gh">#</span> iohyve isolist
Listing ISO&#39;s...
CentOS-7-x86_64-Minimal-1611.iso
</code></pre></div>

<p>Then, to create the machine with 20GB of space (the same size as my existing KVM machine for IPA, which is more than enough):</p>
<div class="highlight"><pre><span></span><code># iohyve create ipa-slave 20G
Creating ipa-slave...
# iohyve list
Guest      VMM?  Running  rcboot?  Description
ipa-slave  NO    NO       NO       Sun Mar 12 16:39:10 MDT 2017
</code></pre></div>

<p>Now you can configure the specifics of the machine:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># iohyve set ipa-slave ram=1G cpu=1 os=custom loader=grub-bhyve</span>
<span class="n">Setting</span><span class="w"> </span><span class="n">ipa</span><span class="o">-</span><span class="n">slave</span><span class="w"> </span><span class="n">ram</span><span class="o">=</span><span class="mi">1</span><span class="n">G</span><span class="o">...</span>
<span class="n">Setting</span><span class="w"> </span><span class="n">ipa</span><span class="o">-</span><span class="n">slave</span><span class="w"> </span><span class="n">cpu</span><span class="o">=</span><span class="mf">1.</span><span class="o">..</span>
<span class="n">Setting</span><span class="w"> </span><span class="n">ipa</span><span class="o">-</span><span class="n">slave</span><span class="w"> </span><span class="n">os</span><span class="o">=</span><span class="n">cuscom</span><span class="o">...</span>
<span class="n">Setting</span><span class="w"> </span><span class="n">ipa</span><span class="o">-</span><span class="n">slave</span><span class="w"> </span><span class="n">loader</span><span class="o">=</span><span class="n">grub</span><span class="o">-</span><span class="n">bhyve</span><span class="o">...</span>
</code></pre></div>

<p>This sets my virtual machine to have 1GB of RAM, use one virtual CPU, use the "custom" operating system type (we need this later, even though we will be using CentOS 7), and uses the grub-bhyve loader which is required by Linux guests.  The <a href="https://github.com/pr1ntf/iohyve/wiki">iohyve wiki</a> has more details on operating system types and which values to use depending on which Linux operating system you intend to install.</p>
<p>When using a CentOS 7 guest, iohyve currently cannot boot from an XFS partition (which is the default), and due to the limitations of the commandline installer, we can't tell Anaconda to use something other than XFS.  Another thing I found, with some trial and error, is you want to use traditional partitions and not the LVM-based partition scheme (so plan out your filesystem in advance to ensure you have enough size!).  This is the main reason for using the "custom" operating system type.  We'll fix that later.</p>
<p>To work around this, we'll use a simple kickstart file to get us to a minimal working system from which we can install the rest of what we want.</p>
<p>In order to make grub boot and use the kickstart file, you need to edit <code>/iohyve/ipa-slave/grub.cfg</code> so it looks like:</p>
<div class="highlight"><pre><span></span><code>linux (cd0)/isolinux/vmlinuz inst.ks=http://somewhere.internal/ks.cfg
initrd (cd0)/isolinux/initrd.img
boot
</code></pre></div>

<p>and the <code>ks.cfg</code> file would look something like (see the <a href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/Installation_Guide/sect-kickstart-syntax.html">documentation</a> for more info):</p>
<div class="highlight"><pre><span></span><code><span class="cp">#version=RHEL7</span>
<span class="cp"># System authorization information</span>
<span class="n">auth</span><span class="w"> </span><span class="o">--</span><span class="n">enableshadow</span><span class="w"> </span><span class="o">--</span><span class="n">passalgo</span><span class="o">=</span><span class="n">sha512</span>

<span class="cp"># Use CDROM installation media</span>
<span class="n">cdrom</span>
<span class="cp"># Use text install</span>
<span class="n">text</span>
<span class="cp"># Run the Setup Agent on first boot</span>
<span class="n">firstboot</span><span class="w"> </span><span class="o">--</span><span class="n">enable</span>
<span class="n">ignoredisk</span><span class="w"> </span><span class="o">--</span><span class="n">only</span><span class="o">-</span><span class="n">use</span><span class="o">=</span><span class="n">sda</span>
<span class="cp"># Keyboard layouts</span>
<span class="n">keyboard</span><span class="w"> </span><span class="o">--</span><span class="n">vckeymap</span><span class="o">=</span><span class="n">us</span><span class="w"> </span><span class="o">--</span><span class="n">xlayouts</span><span class="o">=</span><span class="err">&#39;</span><span class="n">us</span><span class="err">&#39;</span>
<span class="cp"># System language</span>
<span class="n">lang</span><span class="w"> </span><span class="n">en_US</span><span class="p">.</span><span class="n">UTF</span><span class="mi">-8</span>

<span class="cp"># Network information</span>
<span class="n">network</span><span class="w">  </span><span class="o">--</span><span class="n">bootproto</span><span class="o">=</span><span class="k">static</span><span class="w"> </span><span class="o">--</span><span class="n">device</span><span class="o">=</span><span class="n">eth0</span><span class="w"> </span><span class="o">--</span><span class="n">gateway</span><span class="o">=</span><span class="mf">192.168.1.1</span><span class="w"> </span><span class="o">--</span><span class="n">ip</span><span class="o">=</span><span class="mf">192.168.1.16</span><span class="w"> </span><span class="o">--</span><span class="n">nameserver</span><span class="o">=</span><span class="mf">192.168.1.1</span><span class="w"> </span><span class="o">--</span><span class="n">netmask</span><span class="o">=</span><span class="mf">255.255.255.0</span><span class="w"> </span><span class="o">--</span><span class="n">noipv6</span><span class="w"> </span><span class="o">--</span><span class="n">activate</span>
<span class="n">network</span><span class="w">  </span><span class="o">--</span><span class="n">hostname</span><span class="o">=</span><span class="n">ipa</span><span class="o">-</span><span class="n">slave</span><span class="p">.</span><span class="n">mydomain</span><span class="p">.</span><span class="n">com</span>
<span class="cp"># Root password</span>
<span class="n">rootpw</span><span class="w"> </span><span class="o">--</span><span class="n">iscrypted</span><span class="w"> </span><span class="n">$6$</span><span class="o">/</span><span class="n">GdEAa2DwhlmU</span><span class="p">.</span><span class="n">Vr$R</span><span class="o">/</span><span class="n">L</span><span class="p">.</span><span class="n">fEc6QwtFiTMLd04HR1SuS7NrsdA</span><span class="p">.</span><span class="n">NuQyQ17RbBk8p37oGD</span><span class="o">/</span><span class="n">hVvRIOw0v5x6pSC6uU4NigueNmEXvQ8pzo0</span>
<span class="cp"># System services</span>
<span class="n">services</span><span class="w"> </span><span class="o">--</span><span class="n">enabled</span><span class="o">=</span><span class="s">&quot;chronyd&quot;</span>
<span class="cp"># System timezone</span>
<span class="n">timezone</span><span class="w"> </span><span class="n">America</span><span class="o">/</span><span class="n">Edmonton</span><span class="w"> </span><span class="o">--</span><span class="n">isUtc</span><span class="w"> </span><span class="o">--</span><span class="n">ntpservers</span><span class="o">=</span><span class="n">ntp</span><span class="p">.</span><span class="n">mydomain</span><span class="p">.</span><span class="n">com</span>
<span class="cp"># System bootloader configuration</span>
<span class="n">bootloader</span><span class="w"> </span><span class="o">--</span><span class="n">location</span><span class="o">=</span><span class="n">mbr</span><span class="w"> </span><span class="o">--</span><span class="n">boot</span><span class="o">-</span><span class="n">drive</span><span class="o">=</span><span class="n">sda</span>
<span class="cp"># Partition clearing information</span>
<span class="n">clearpart</span><span class="w"> </span><span class="o">--</span><span class="n">drives</span><span class="o">=</span><span class="n">sda</span><span class="w"> </span><span class="o">--</span><span class="n">all</span>
<span class="cp"># Disk partitioning information</span>
<span class="n">autopart</span><span class="w"> </span><span class="o">--</span><span class="n">type</span><span class="o">=</span><span class="n">plain</span><span class="w"> </span><span class="o">--</span><span class="n">fstype</span><span class="o">=</span><span class="s">&quot;ext4&quot;</span>

<span class="nf">%packages</span>
<span class="n">chrony</span>
<span class="nf">%end</span>

<span class="nf">%addon</span><span class="w"> </span><span class="n">com_redhat_kdump</span><span class="w"> </span><span class="o">--</span><span class="n">disable</span><span class="w"> </span><span class="o">--</span><span class="n">reserve</span><span class="o">-</span><span class="n">mb</span><span class="o">=</span><span class="err">&#39;</span><span class="k">auto</span><span class="err">&#39;</span>

<span class="nf">%end</span>
</code></pre></div>

<p>Before starting the installation, make sure you can retrieve that file with something like curl.  Next, start the installation:</p>
<div class="highlight"><pre><span></span><code><span class="gh">#</span> iohyve isolist
Listing ISO&#39;s...
CentOS-7-x86_64-Minimal-1611.iso
<span class="gh">#</span> iohyve install ipa-slave CentOS-7-x86_64-Minimal-1611.iso
Installing ipa-slave...
GRUB Process does not run in background....
If your terminal appears to be hanging, check iohyve console ipa-slave in second terminal to complete GRUB process...
</code></pre></div>

<p>From another terminal, ssh into your FreeNAS server again in order to connect to the serial console by using:</p>
<div class="highlight"><pre><span></span><code><span class="gh">#</span> iohyve console ipa-slave
Starting console on ipa-slave...
~~. to escape console [uses cu(1) for console]
Connected
...
Starting installer, one moment...
anaconda 21.48.22.93-1 for CentOS Linux 7 started.
 <span class="k">*</span> installation log files are stored in /tmp during the installation
 <span class="k">*</span> shell is available on TTY2
 <span class="k">*</span> when reporting a bug add logs from /tmp as separate text/plain attachments
14:21:39 Not asking for VNC because of an automated install
14:21:39 Not asking for VNC because text mode was explicitly asked for in kickstart

Starting automated install..
...
</code></pre></div>

<p>Now sit back while it automatically installs.  This will be quite the minimal install, however it will get you up and running with an ext4-based system that iohyve can boot up, and from there you can install individual packages or package groups.</p>
<p>When the install is complete, you will see something like this on the console:</p>
<div class="highlight"><pre><span></span><code>[  OK  ] Started Restore /run/initramfs.
[  OK  ] Reached target Shutdown.
dracut Warning: Killing all remaining processes
Rebooting.
[  819.859124] Restarting system.
</code></pre></div>

<p>However, it's not actually restarting the system.  Switch back to the other console and you will see:</p>
<div class="highlight"><pre><span></span><code>Unhandled ps2 keyboard command 0xf6

# iohyve list
Guest      VMM?  Running  rcboot?  Description
ipa-slave  YES   NO       NO       Sun Mar 12 16:39:10 MDT 2017
</code></pre></div>

<p>As you can see from the <code>list</code> command, the virtual machine is not running even though it said it was restarting.  In order to start the machine, you must use:</p>
<div class="highlight"><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="n">iohyve</span><span class="w"> </span><span class="k">start</span><span class="w"> </span><span class="n">ipa</span><span class="o">-</span><span class="n">slave</span>
<span class="n">Starting</span><span class="w"> </span><span class="n">ipa</span><span class="o">-</span><span class="n">slave</span><span class="p">...</span><span class="w"> </span><span class="p">(</span><span class="n">Takes</span><span class="w"> </span><span class="mi">15</span><span class="w"> </span><span class="n">seconds</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">FreeBSD</span><span class="w"> </span><span class="n">guests</span><span class="p">)</span>
<span class="o">[</span><span class="n">root@heimdall</span><span class="o">]</span><span class="w"> </span><span class="o">~</span><span class="err">#</span><span class="w"> </span><span class="n">GRUB</span><span class="w"> </span><span class="n">Process</span><span class="w"> </span><span class="n">does</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">background</span><span class="p">....</span>
<span class="k">If</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="n">terminal</span><span class="w"> </span><span class="n">appears</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">hanging</span><span class="p">,</span><span class="w"> </span><span class="k">check</span><span class="w"> </span><span class="n">iohyve</span><span class="w"> </span><span class="n">console</span><span class="w"> </span><span class="n">ipa</span><span class="o">-</span><span class="n">slave</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="k">second</span><span class="w"> </span><span class="n">terminal</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">complete</span><span class="w"> </span><span class="n">GRUB</span><span class="w"> </span><span class="n">process</span><span class="p">...</span>
</code></pre></div>

<p>Now switch back to the original console (that you've not disconnected) and you will see the system booting.  I had some difficulty with dracut-initqueue warning about incessant timeouts, so it took some time for the system to boot and even then I ended up in a rescue shell.</p>
<p>As annoying as this is, it's not too terribly difficult to solve although I hate how hackish it needs to be.  The root of the problem <em>seems</em> to be that dracut wants to connect to this kickstart file before the network is up.  So we need to do some chroot shenanigans and fix the initramfs:</p>
<div class="highlight"><pre><span></span><code><span class="gh">#</span> mkdir /mnt
<span class="gh">#</span> mount /dev/sda3 /mnt
<span class="gh">#</span> mount /dev/sda1 /mnt/boot
<span class="gh">#</span> chroot /mnt
<span class="gh">#</span> cd /boot
<span class="gh">#</span> cp initramfs-3.10.0-514.el7.x86_64.img initramfs-3.10.0-514.el7.x86_64.img.bak
<span class="gh">#</span> dracut -f /boot/initramfs-3.10.0-514.el7.x86_64.img 3.10.0-514.el7.x86_64
<span class="gh">#</span> ls -al initramfs*
-rw-------  1 root root 45180381 Mar 14 08:24 initramfs-0-rescue-715baff9360a47a89af2ddbc55b9f0cf.img
-rw-------  1 root root 44766225 Mar 14 09:26 initramfs-3.10.0-514.el7.x86_64.img
-rw-------  1 root root 17437682 Mar 14 09:25 initramfs-3.10.0-514.el7.x86_64.img.bak
</code></pre></div>

<p>Judging by the difference in size between the rescue image, the newly created image, and the previous one that was copied, this is a pretty strong indication that something is missing.</p>
<p>Also, there are a few more steps to do before we can get CentOS 7 booted properly.  The first is to edit <code>/iohyve/ipa-slave/grub.conf</code> and remove the kickstart reference.  I'm not 100% sure this is required after we perform the next action, but after a lot of beard-tugging (and to spare you the same) I'm suggesting you remove it.  Also, you need to set the operating system type back to CentOS 7:</p>
<div class="highlight"><pre><span></span><code># iohyve set ipa-slave os=centos7
Setting ipa-slave os=centos7...
</code></pre></div>

<p>If you've stopped the virtual machine, great, if it's still waiting for network timeouts, you can forcibly stop it with <code>iohyve destroy ipa-slave</code> and then we can use <code>iohyve start ipa-slave</code> to start it back up again (this from the session not attached to the console, of course).</p>
<p>Now on the console, you should be able to watch the virtual machine boot and arrive at a login prompt.</p>
<p>Once you login, you probably want to install a few other things given we opted for the minimal install:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># yum update -y</span>
<span class="c1"># yum install net-tools vim-enhanced zsh ipa-server</span>
<span class="c1"># systemctl status sshd</span>
</code></pre></div>

<p>The last is to make sure that sshd is running so you can ssh in and carry on (at least for me, an 80x25 console is pretty darn tiny).  I also prefer the enhanced vim, and having tools like ipaddr and ifconfig are just plain old handy, and of course the whole point of this exercise was to set this up as an IPA server.</p>
<p>Finally, once you verify you can ssh into the server, disconnect from the console by typing the tilde and CTRL-D (so <code>~ + CTRL-D</code>).</p>
<p>To finish up, let's give the virtual machine a decent description and tell it to start at boot:</p>
<div class="highlight"><pre><span></span><code># iohyve set ipa-slave description=&quot;IPA Slave server&quot;
Setting ipa-slave description=IPA Slave server...
#  iohyve set ipa-slave boot=1
Setting ipa-slave boot=1...
# iohyve list
Guest      VMM?  Running  rcboot?  Description
ipa-slave  YES   YES      YES      IPA Slave server
</code></pre></div>

<p>At this point, you can make a backup or snapshot of the virtual machine (which is one of the first things I wanted to do after all of the effort of figuring out the above!):</p>
<div class="highlight"><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="n">iohyve</span><span class="w"> </span><span class="n">snap</span><span class="w"> </span><span class="n">ipa</span><span class="o">-</span><span class="n">slave</span><span class="nv">@base</span><span class="o">-</span><span class="n">install</span><span class="o">-</span><span class="mi">20170314</span>
<span class="n">Taking</span><span class="w"> </span><span class="n">snapshot</span><span class="w"> </span><span class="n">ipa</span><span class="o">-</span><span class="n">slave</span><span class="nv">@base</span><span class="o">-</span><span class="n">install</span><span class="o">-</span><span class="mi">20170314</span>
<span class="err">#</span><span class="w"> </span><span class="n">iohyve</span><span class="w"> </span><span class="n">snaplist</span>
<span class="n">ipa</span><span class="o">-</span><span class="n">slave</span><span class="nv">@base</span><span class="o">-</span><span class="n">install</span><span class="o">-</span><span class="mi">20170314</span>
</code></pre></div>

<p>Currently there doesn't seem to be a way to remove snapshots.</p>
<p>I haven't played with it enough to know whether or not the performance is better than KVM on Linux, but I enjoyed fiddling with this to get it figured out and working.  Hopefully this is helpful to others; there have been quite a few references to the desire to run CentOS 7 on FreeNAS using iohyve, but even the upstream site indicates it is currently not possible (although according to <a href="https://github.com/pr1ntf/iohyve/issues/224#issuecomment-274279896">this comment</a>, it's on the roadmap).  With a bit of fiddling, it <em>is</em> possible.</p>
<p>The next step now is to figure out how to get an IPA replication slave setup because the documentation is <em>not</em> intuitive at all and setting up a replicated slave is about the only way to migrate IPA from one machine to another.  Wish me luck, and I hope this is helpful to people interested in running CentOS 7 with iohyve.</p>


             
 
            
            
            







            <hr/>
        </div>
        <section id="article-sidebar" class="span2">
            <h4>Published</h4>
            <time itemprop="dateCreated" datetime="2017-03-24T16:00:00-06:00">Fri 24 March 2017</time>
            <h4>Category</h4>
            <a class="category-link" href="https://vdanen.github.io/categories.html#bsd-ref">Bsd</a>
            <h4>Tags</h4>
            <ul class="list-of-tags tags-in-article">
                <li><a href="https://vdanen.github.io/tags.html#centos-ref">centos
                    <span class="superscript">5</span>
</a></li>
                <li><a href="https://vdanen.github.io/tags.html#freenas-ref">freenas
                    <span class="superscript">7</span>
</a></li>
                <li><a href="https://vdanen.github.io/tags.html#iohyve-ref">iohyve
                    <span class="superscript">1</span>
</a></li>
                <li><a href="https://vdanen.github.io/tags.html#ipa-ref">ipa
                    <span class="superscript">3</span>
</a></li>
            </ul>
<h4>Contact</h4>
<div id="sidebar-social-link">
    <a href="https://twitter.com/vdanen" title="" target="_blank" rel="nofollow noopener noreferrer">
        <svg xmlns="http://www.w3.org/2000/svg" aria-label="Twitter" role="img" viewBox="0 0 512 512"><rect width="512" height="512" rx="15%" fill="#1da1f3"/><path fill="#fff" d="M437 152a72 72 0 0 1-40 12 72 72 0 0 0 32-40 72 72 0 0 1-45 17 72 72 0 0 0-122 65 200 200 0 0 1-145-74 72 72 0 0 0 22 94 72 72 0 0 1-32-7 72 72 0 0 0 56 69 72 72 0 0 1-32 1 72 72 0 0 0 67 50 200 200 0 0 1-105 29 200 200 0 0 0 309-179 200 200 0 0 0 35-37"/></svg>
    </a>
    <a href="https://github.com/vdanen" title="" target="_blank" rel="nofollow noopener noreferrer">
        <svg xmlns="http://www.w3.org/2000/svg" aria-label="GitHub" role="img" viewBox="0 0 512 512"><rect width="512" height="512" rx="15%" fill="#1B1817"/><path fill="#fff" d="M335 499c14 0 12 17 12 17H165s-2-17 12-17c13 0 16-6 16-12l-1-50c-71 16-86-28-86-28-12-30-28-37-28-37-24-16 1-16 1-16 26 2 40 26 40 26 22 39 59 28 74 22 2-17 9-28 16-35-57-6-116-28-116-126 0-28 10-51 26-69-3-6-11-32 3-67 0 0 21-7 70 26 42-12 86-12 128 0 49-33 70-26 70-26 14 35 6 61 3 67 16 18 26 41 26 69 0 98-60 120-117 126 10 8 18 24 18 48l-1 70c0 6 3 12 16 12z"/></svg>
    </a>
    <a href="https://www.linkedin.com/in/vdanen/" title="" target="_blank" rel="nofollow noopener noreferrer">
        <svg xmlns="http://www.w3.org/2000/svg" aria-label="LinkedIn" role="img" viewBox="0 0 512 512" fill="#fff"><rect width="512" height="512" rx="15%" fill="#0077b5"/><circle cx="142" cy="138" r="37"/><path stroke="#fff" stroke-width="66" d="M244 194v198M142 194v198"/><path d="M276 282c0-20 13-40 36-40 24 0 33 18 33 45v105h66V279c0-61-32-89-76-89-34 0-51 19-59 32"/></svg>
    </a>
    <a href="https://infosec.exchange/@vdanen" title="" target="_blank" rel="nofollow noopener noreferrer">
        <svg xmlns="http://www.w3.org/2000/svg" aria-label="Mastodon" role="img" viewBox="0 0 512 512" fill="#fff"><rect width="512" height="512" rx="15%"/><path d="m409 290c-5 24-43 50-85 56-86 11-137-6-137-6 3 13-4 54 70 52 31 0 58-7 58-7l2 27c-51 24-107 15-140 6-67-17-79-90-81-162v-59c0-74 49-96 49-96 50-24 180-22 222 0 0 0 49 22 49 96 0 0 1 55-7 93" fill="#3088d4"/><path d="m358 202v91h-35v-88c0-18-8-27-23-27-18 0-27 11-27 33v47h-34v-47c0-22-9-33-27-33-15 0-23 9-23 27v88h-35v-91c0-18 5-60 52-60 39 0 50 37 50 37s10-37 50-37c45 0 52 42 52 60"/></svg>
    </a>
</div>
            





            





        </section>
</div>
</article>
<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe.
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides.
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo https://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>                    </div>
                    <div class="span1"></div>
                </div>
            </div>
        </div>
<footer>




    <div id="fpowered">
        Powered by: <a href="http://getpelican.com/" title="Pelican Home Page" target="_blank" rel="nofollow noopener noreferrer">Pelican</a>
        Theme: <a href="https://elegant.oncrashreboot.com/" title="Theme Elegant Home Page" target="_blank" rel="nofollow noopener noreferrer">Elegant</a>
    </div>
</footer>            <script src="//code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
        <script src="https://vdanen.github.io/theme/js/elegant.prod.9e9d5ce754.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

    <script>
    (function () {
        if (window.location.hash.match(/^#comment-\d+$/)) {
            $('#comment_thread').collapse('show');
        }
    })();
    window.onhashchange=function(){
        if (window.location.hash.match(/^#comment-\d+$/))
            window.location.reload(true);
    }
    $('#comment_thread').on('shown', function () {
        var link = document.getElementById('comment-accordion-toggle');
        var old_innerHTML = link.innerHTML;
        $(link).fadeOut(200, function() {
            $(this).text('Click here to hide comments').fadeIn(200);
        });
        $('#comment_thread').on('hidden', function () {
            $(link).fadeOut(200, function() {
                $(this).text(old_innerHTML).fadeIn(200);
            });
        })
    })
</script>

    </body>
    <!-- Theme: Elegant built for Pelican
        License : MIT -->
</html>